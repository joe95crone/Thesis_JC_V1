%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Doctoral Thesis Template @ The University of Manchester
% LaTeX Chapter Template
% Version 1 (23/07/2020)
% Joe Crone
%
% This template is based on:
% The University of Manchester, Presentation of Thesis Policy
% Research Office Graduate Education Team
% June 2017
% http://www.regulations.manchester.ac.uk/pgr-presentation-theses/
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[../main.tex]{subfiles}
\begin{document}

% Title
%--------------------------------------------------------
\chapter{Energy Recovery Linac Design}
\label{Energy_Recovery_Linac_Design} % to reference use \ref{ChapterTemplate}

\textcolor{blue}{**HYWEL SUGGESTS TO FOLLOW JAMES JONES THESIS, BUT WITH LESS DETAIL**}
\textcolor{blue}{https://www.research.manchester.ac.uk/portal/en/theses/design-of-a-novel-stacked-storage-ring-for-low-emittance-light-sources(53cedd16-ea4d-4343-abc9-78886a934a9b).html}

% Follow James Jones Thesis (minus some irrelevant parts) but include sections on ERLs and  Collective Effects

\section{Equations of Motion in Particle Accelerators}

\subsection{Co-ordinate System}
\textcolor{blue}{**DEFINE REFERENCE ORBIT**}

In particle accelerators bending fields are often used to direct the particles to a certain experimental station downstream of the particle sources, and many particle accelerators re-circulate particle beams. The particles are directed along an ideal trajectory named -- since in a recirculated machine the trajectory is closed -- a reference orbit. Therefore, since bending forces are introduced, the motion of particles within an accelerator environment can best be described by a right handed rotating co-moving co-ordinate system \cite{wille2000physics}. The right handed co-moving co-ordinate system is shown in Fig. \textcolor{blue}{**DIAGRAM OF CIRCULAR CO-ORD**}   

The co-ordinate system in Fig. \textcolor{blue}{**REF DIAGRAM COORD**} used to describe motion in particle accelerators within this thesis is of the form $\Kappa = \left\{x,y,s\right\}$, describing the local co-ordinate system where the transverse motion along the horizontal direction is in the $x$-axis and the vertical axis in $y$ is orthogonal to this and the direction of longitudinal motion $s$. Within this thesis, the $\Kappa = \left\{x,y,s\right\}$ co-ordinate system is maintained in situations with no bending magnets, such as linear accelerators.     

\subsection{Magnetic Fields in Particle Accelerators}

The motion of a charged particle in an electromagnetic field is given by the Lorentz force 
\begin{equation}
\overrightarrow{F} = q\left(\overrightarrow{E}+\overightarrow{v}\times\overrightarrow{B}\right),
\label{eq:Lorentz_force}    
\end{equation}
where $q$ is the charge of the particle with velocity vector $\overrightarrow{v}$, subject to an electric field $\overrightarrow{E}$ and magnetic field $\overrightarrow{B}$. When an elementary particle is subject solely to a magnetic field ($\overrightarrow{E}=0$), as common in an accelerator magnet, the Lorentz force (Eq.~\ref{eq:Lorentz_force}) can be re-cast into a more appropriate form using the displacement $x$ and time $t$
\begin{equation}
\frac{d^{2}\overrightarrow{x}}{dt^{2}} = \frac{e}{\gamma m}\left(\overrightarrow{v}\times\overrightarrow{B}\right)
\label{eq:displacement_Lorentz}    
\end{equation}
where $e$ is the elementary charge of the particle, $m$ is its rest mass and
\begin{equation}
\gamma = \frac{1}{\sqrt{1-\beta^{2}}} = \frac{E+m}{m},
\label{eq:Lorentz_factor}    
\end{equation}
is the Lorentz factor where $\beta = v/c$ is the Lorentz speed factor and $E$ is the kinetic energy of the particle. Note that, unless explicitly stated, the ultra-relativistic approximation $pc = \sqrt{E^{2}-m^{2}c^{4}} \approx E$, valid for particles with $E \gg mc^{2}$ is used throughout this thesis as the particle energies involved consistently satisfy this approximation.   

Since this thesis is concerned with re -circulated accelerators, particles typically require bending within the horizontal plane. To illustrate particle motion in a bending system we consider a pure, homogenous vertical magnetic field $B_{y}$ produced by a magnet with infinite pole width acting upon the particle of momentum $p_{0}$ (in convenient units of \si{\electronvolt}$/c$) to provide a bending radius of $\rho$ given by
\begin{equation}
\frac{1}{\rho} = \frac{eB_{y}}{p_{0}} = k_{0},
\label{magnet_bending_radius}    
\end{equation}
where $k_{0}$ is the field strength of the magnet -- named a dipole magnet -- with no transverse co-ordinate dependence of the field. By convention of $n$th order magnets, we classify this as the zeroth-order magnet ($n=0$). The magnetic beam rigidity $B\rho$ can therefore be defined as
\begin{equation}
B\rho = \frac{p_{0}}{e},
\label{eq:magnetic_beam_rigidity}    
\end{equation}
and the bending angle $\alpha_{0}$ can be defined with reference to the magnetic beam rigidity
\begin{equation}
\alpha_{0} = \frac{\int B_{y} ds}{B\rho} = \frac{L_{eff}}{\rho}, 
\label{eq:dipole_bending_angle}    
\end{equation}
where the vertical magnetic field (dipole magnetic field) is integrated over the longitudinal distance traversed -- $L_{\mathrm{eff}}$ the effective longitudinal distance traverse by the particle in the field.

Accelerators are typically concerned with beams of particles -- an ensemble of particles -- which can be transversely distributed around the ideal reference orbit hence particles may be  displaced horizontally ($\Delta x$) or vertically ($\Delta y$) from the reference orbit, which can occur due to their natural divergence. Therefore, a restorative 'focusing' force is required to counter the natural divergence of these particles. Within accelerators a quadrupole magnet, a magnet with 4 alternating equidistant (from the pole centre), poles is typically used to provide the required focusing field, which takes the form of a transverse linearly varying magnetic field increasing in strength with distance from the pole centre. We term this a first order magnet ($n=1$). An azimuthal field gradient of the form $g = B_{\phi}/dr$ is pprovided, with $r$ the radial distance from the pole centre. The scalar potential of such a quadrupole field has the from
\begin{equation}
V = -gxy,
\label{eq:quadrupole_potential}    
\end{equation}
where the partial derivatives form the linearly varying magnetic fields
\begin{align}
B_{x} &= -\frac{\partial V}{\partial x} = gy, \nonumber\\
B_{y} &= -\frac{\partial C}{\partial y} = gx.
\end{align}
Therefore, using the same formalism as (Eq.~\ref{eq:dipole_bending_angle}), the focusing angle $\alpha_{1}$ of a quadrupole can be generalised to
\begin{equation}
\alpha_{1} = \frac{e}{p_{0}}grl_{\mathrm{quad}} = -k_{1}rl_{quad},
\label{eq:quadrupole_focusing_angle}    
\end{equation}
where $l_{\mathrm{quad}}$ is the length of the quadrupole magnet and the normalised quadrupole gradient $k_{1}$ becomes
\begin{equation}
k_{1} = \frac{e}{p_{0}}g.
\label{eq:quadrupole_normalised_gradient}
\end{equation}
Quadrupole focusing is analogous to focusing with an optical lens, however a lens focuses simultaneously in all transverse directions whereas a quadrupole that is focusing in the horizontal plane is defocusing in the vertical plane. In the standard defined right handed co-ordinate system \textcolor{blue}{**REFERENCE CO-ORD IMAGE**}, when $k_{1} > 0$, the quadrupole is horizontally focusing (vertically defocusing) and when $k_{1} < 0$, the quadrupole is vertically focusing (horizontally defocusing). Consequently, with the transverse variation in focusing behaviour, a quadrupole can not be considered a true 'magnetic lens' however, taking inspiration from ray optics, the focal length of a quadrupole $f_{\mathrm{quad}}$ can be described as
\begin{equation}
\frac{1}{f_{\mathrm{quad}}} = k_{1}l_{\mathrm{quad}}.
\label{eq:focal_length}    
\end{equation}
The similarities between an optical lens and a quadrupole are highlighted in Fig. \textcolor{blue}{**LENS/DOUBLET DIAGRAM**}, which shows a simple focusing defocusing scheme -- the quadrupole doublet. 

\textcolor{blue}{**Higher Order Magnets + Multipoles**}
The computation of the magnetic field of an arbitrary $n$th order magnet typically uses a multipole expansion of the scalar potential of the magnetic field, which for convenience is presented in cylindrical polar co-ordinates \cite{shepherd2016magnet}
\begin{equation}
V = \sum_{n=0}^{\infty} J_{n+1}r^{n+1}\cos\left[\left(n+1\right)\theta\theta\right]+K_{n+1}r^{n+1}\sin\left[\left(n+1\right)\theta\right],
\label{eq:multipole_scalar_potential}    
\end{equation}
where $n \geq 0$ is the order of the magnet, $\theta$ is the polar angle from the horizontal plane  $x$--$z$ plane, and the coefficients $J_{n+1}$ and $K_{n+1}$ relate to the geometry of the magnet and its normalised field strength, for example for a quadrupole magnet ($n=1$) $K_{2}=0$ means this is a skew quadrupole rotated 90\si{\degree} around the pole axis and $J_{2}=0$ relates to a normal quadrupole field. The corresponding magnetic flux density of the magnet can be calculated for the radial $B_{r}$ or polar angle $B_{\theta}$ case by    
\begin{align}
B_{r} &= -\frac{\partial V}{\partial r}, & B_{\theta} &= -\frac{\partial V}{\partial \theta},
\label{eq:multipole_magnetic_field_cylindrical}    
\end{align}
and similarly in Cartesian co-ordinates, with proper transformation the magnetic flux density in each transverse plane is
\begin{align}
B_{x} &= -\frac{\partial V}{\partial x}, & B_{y} &= -\frac{\partial V}{\partial y}.
\label{eq:multipole_magnetic_field_cartesian}
\end{align}
The normalised field gradient of an $n$th order magnet is generalised to
\begin{equation}
k_{n} = \frac{e}{p_{0}}\frac{\partial^{n} B_{y}}{\partial x^{n}}.
\label{eq:multipole_normalised_field_gradient}    
\end{equation}
For example, for a sextupole ($n=2$) magnet with 6 poles the magnetic flux density is given by
\begin{align}
B_{x} &= k_{2}xy, \nonumber \\
B_{y} &= \frac{k_{2}}{2}\left(x^{2}-y^{2}\right),
\label{eq:sextupole_magnetic_field}    
\end{align}
wiith the normalised field gradient given by 
\begin{equation}
k_{2} = \frac{e}{p_{0}}\frac{\partial^{2}B_{y}}{\partial x^{2}}.
\label{eq:sextupole_field_gradient}    
\end{equation}

A magnet may have more than a single order field simultaneously. For example, a magnet utilising both linear fields (dipole and quadrupole fields) can be constructed -- named a combined function magnet -- which in this case would combine a dipole bending field component and a quadrupole focusing field component. A linear combined function magnet of can be achieved either by offsetting the pole centre of a quadrupole from the reference trajectory or by linearly varying the gap between magnetic poles transversely across the pole face of a dipole magnet. The former strategy is employed in the CBETA ERL FFA return loop, an accelerator explained in more detail in Chapter~\ref{CBETA_Multi-Pass_Commissioning}. The transverse magnetic field of a combined function dipole--quadrupole magnet, bending in the horizontal plane, is given by 
\begin{align}
B_{x} &= \frac{p_{0}}{e}k_{1}y, \nonumber\\
B_{y} &= \frac{p_{0}}{e}\left(k_{0}+k_{1}x\right).
\label{eq:combined_function_field}    
\end{align}

\subsection{Linear Equations of Motions}

The linear equations of motion for a particle follow the derivation of Rossbach and Schmuser \cite{rossbach1993basic} and K. Willie \cite{wille2000physics}, using the co-ordinate system presented in Fig. \textcolor{blue}{**CO-ORD SYS DIAG**}. Here an equation of particle motion due to the Lorentz force (Eq.~\ref{eq:Lorentz_force}) is developed for the co-ordinate system which rotates due to bending forces, which we limit to the horizontal $x$--$s$ plane. We define the position vector of a particle at an arbitrary point in it's trajectory, in the global cyclindrical co-ordinate system $\left\{r,\alpha,z\right\}$ as
\begin{equation}
\boldsymbol{R} = \boldsymbol{R}_{0} + r\boldsymbol{u}_{r} + z\boldsymbol{u}_{z},    
\label{eq:particle_position_vector}
\end{equation}
where $R_{0}$ is the distance of the particle from an arbitrary origin point and $\boldsymbol{u}_{r}$, $\boldsymbol{u}_{\alpha}$, $\boldsymbol{u}_{z}$ are unit vectors describing the motion of the particle. Assuming a small variation in azimuthal angle $d\theta$, the relations between the unit vectors become
\begin{align}
\frac{d\boldsymbol{u}_{r}}{d\alpha} &= \boldsymbol{u}_{\alpha}, & \frac{d\boldsymbol{u}_{\alpha}}{d\alpha} &= -\boldsymbol{u}_{r}, & \frac{d\boldsymbol{u}_{z}}{d\alpha} &= 0.
\label{eq:unit_vector_angular_derivatives}    
\end{align}
The velocity of the particle is given by
\begin{align}
\frac{d\boldsymbol{R}}{dt} &= \frac{dr}{dt}\boldsymbol{u}_{r}+r\frac{d\boldsymbol{u}_{r}}{dt} +\frac{dz}{dt}\boldsymbol{u}_{z}, \nonumber \\
\frac{d\boldsymbol{R}}{dt} &= \frac{dr}{dt}\boldsymbol{u}_{r} + r\frac{d\alpha}{dt}\boldsymbol{u}_{\alpha} + \frac{dz}{dt}\boldsymbol{u}_{z},
\label{eq:unit_vector_velocity}    
\end{align}
and differentiating within respect to time, the acceleration becomes
\begin{equation}
\frac{d^{2}\boldsymbol{E}}{dt^{2}} = \left(\frac{d^{2}r}{dt^{2}}-r\frac{d^{2}\alpha}{dt^{2}}\right)\boldsymbol{u}_{r} + \left(2\frac{dr}{dt}\frac{d\alpha}{dt}\right)\boldsymbol{u}_{\alpha} + \frac{d^{2}z}{dt^{2}}\boldsymbol{u}_{z},
\label{eq:unit_vector_acceleration}    
\end{equation}
within the first $\boldsymbol{u}_{r}$ term, the first part describes the effect of the variation of bending on the acceleration and the second part relates to the centrifugal acceleration of the particle. The force of the particle of mass $m$, using the acceleration (Eq.~\ref{eq:unit_vector_acceleration}), can be equated with the Lorentz force (Eq.~\ref{eq:Lorentz_force}) of the magnetic field due to the accelerator magnets ($\overightarrow{E}=0$)
\begin{equation}
m\frac{d^{2}\boldsymbol{R}}{dt^{2}}=-e\left(\overightarrow{v}\times\overightarrow{B}\right),
\label{eq:Lorentz_particle_equating_forces}
\end{equation}
which, by describing the magnetic flux density vector in cylindrical co-ordinates $\overightarrow{B} = \left(B_{r},B_{\alpha},B_{z}\right)$, can be expanded to
\begin{equation}
m\frac{d^{2}\boldsymbol{R}}{dt^{2}} = -e\left[\left(r\frac{d\alpha}{dt}B_{z}-\frac{dz}{dt}B_{\alpha}\right)\boldsymbol{u}_{r}+\left(\frac{dz}{dt}B_{r}-\frac{dr}{dt}B_{z}\right)\boldsymbol{u}_{\alpha}+\left(\frac{dr}{dt}B_{\alpha}-r\frac{d\alpha}{dt}B_{r}\right)\boldsymbol{u}_{z}\right].
\label{eq:Lorentz_particle_equating_forces_expanded}    
\end{equation}
Assuming that $B_{\alpha}=0$, as there is no longitudinally applied magnetic field -- as this would be in the direction of motion of the particle -- we obtain a set of two differential equations
\begin{align}
m\left(\frac{d^{2}r}{dt^{2}}-r\frac{d^{2}\alpha}{dt^{2}}\right)=-er\frac{d\alpha}{dt}B_{z},
\label{eq:radial_differential_equation} \\
m\frac{d^{2}z}{dt^{2}}=-er\frac{d\alpha}{dt}B_{r}.
\label{eq:angular_differential_equation}
\end{align}
Assuming a combination of focusing and bending magnets within the accelerator, we approximate these fields by using a the field of a combined function magnet (Eq.~\ref{eq:combined_function_field}). The defined field of a combined function magnet (Eq.~\ref{eq:combined_function_field}) in the local co-ordinate system can be simply equated to the field in the global cylindrical co-ordinate system  because the radial direction of the global co-ordinate system is the same as the horizontal $x$ direction of the local co-ordinate system and the vertical $y$ local co-ordinate direction is analogous to the global $z$ direction. The equivalence of the fields in each co-ordinate system can be expressed as
\begin{align}
B_{r} = B_{x} &= \frac{p_{0}}{e}k_{1}y, \\
B_{z} = B_{y} &= \frac{p_{0}}{e}\left(k_{0}+k_{1}x\right),
\label{eq:equivalent_combined_function_field}
\end{align}
Substituting the combined function magnetic flux density (Eq.~\ref{eq:equivalent_combined_function_field}) into the differential equations (Eqs.~\ref{eq:radial_differential_equation}, \ref{eq:angula_differential_equation}) and making the substitution $r=\rho+x$ to account for varying transverse position around the reference orbit yields
\begin{align}
m\left(\frac{d^{2}x}{dt^{2}}-\left(p+x\right)\frac{d^{2}\alpha}{dt^{2}}\right) &=-p_{0}\left(\rho+x\right)\frac{d\alpha}{dt}\left(k_{0}+k_{1}\right), 
\label{eq:horizontal_differential_equation}\\   
m\frac{d^{2}z}{dt^{2}} &= -p_{0}\left(\rho+x\right)\frac{d\alpha}{dt}k_{1}z.
\label{eq:vertical_differential_equation}
\end{align}
The azimuthal component of the velocity has the form
\begin{equation}
v_{\alpha} = \left(\rho+x\right)\frac{d\alpha}{dt},
\label{eq:azimuthal_velocity}    
\end{equation}
which is typically much larger than the radial and vertical component ($v_{\alpha}\gg v_{r},~v_{z}$), which enables the approximation $v\approx v_{\alpha}$ that the azimuthal velocity is the velocity of the particle. Using this approximation a series of variables can be replaced using
\begin{align}
s&=vt, & \frac{d^{2}x}{dt^{2}} &= v^{2}\frac{d^{2}x}{ds^{2}},
\label{eq:velocity_approximation_replacing_variables}    
\end{align}
which can then be used to re-cast (Eqs.~\ref{eq:horizontal_differential_equation}, \ref{eq:vertical_differential_equation}) to obtain
\begin{align}
\frac{d^{2}x}{ds^{2}} &= -\frac{p_{0}}{mv}\frac{1}{\rho+x}\left(k_{0}+k_{1}x\right),
\label{eq:horizontal_recast_differential_equation} \\
\frac{d^{2}z}{ds^{2}} &= -\frac{p_{0}}{mv}k_{1}z.
\label{eq:vertical_recast_differential_equation}
\end{align}
Variation in the design momentum $\Delta p$ is introduced via
\begin{equation}
mv = p = p_{0}\left(1+\frac{\Delta p}{p_{0}}\right),
\label{eq:design_momentum_variation}    
\end{equation}
which means the transverse $r$ co-ordinate can be re-cast, when $\rho \gg x$, as
\begin{equation}
\frac{1}{r}\approx \frac{1}{\rho}\left(1-\frac{x}{\rho}\right). 
\label{eq:r_rho_relation}
\end{equation}
By introducing the momentum variation (Eq.~\ref{eq:design_momentum_variation}) and the approximation of the radial component (Eq.~\ref{eq:r_rho_relation}), the equations of motion can be shown in their familiar form \cite{rossbach1993basic,wille2000physics}
\begin{align}
\frac{d^{2}x}{ds^{2}} +\left(k_{1}+\frac{1}{\rho^{2}}\right)x &= \frac{1}{\rho}\frac{\Delta p}{p_{0}},
\label{eq:horizontal_equation_of_motion} \\
\frac{d^{2}z}{ds^{2}} - k_{1}z &= 0,
\label{eq:vertical_equation_of_motion}
\end{align}
where the focusing terms of the equations of motion, arising from the focusing component $k_{1}$ and the bending component $1/\rho^{2}$ can be combined into a single term
\begin{align}
\frac{d^{2}x}{ds^{2}} + K_{x}x &= \frac{1}{\rho}\frac{\Delta p}{p_{0}},
\label{eq:horizontal_equation_of_motion_simplified} \\
\frac{d^{2}z}{ds^{2}} + K_{z}z &= 0,
\label{eq:vertical_equation_of_motion_simplified}
\end{align}
where
\begin{align}
K_{x} &= k_{1} + \frac{1}{\rho^{2}}. \nonumber\\
K_{z} &= -k_{1}.
\label{eq:focusing_equation_of_motion}    
\end{align}
The equations of motion (Eqs.~\ref{eq:horizontal_equation_of_motion_simplified}, \ref{eq:vertical_equation_of_motion_simplified}) have the form of a harmonic oscillator.

Solutions to the equations of motion (Eqs.~\ref{eq:horizontal_equation_of_motion_simplified}, \ref{eq:vertical_equation_of_motion_simplified}) can therefore be found by linear combinations of sine and cosine terms which, for the focusing case ($K>0$) have the form
\begin{align}
C\left(s\right) &= \cos\left(\sqrt{K}s\right), \nonumber\\
S\left(s\right) &= \frac{1}{\sqrt{K}}\sin\left(\sqrt{K}s\right),
\label{eq:focusing_solution_equation_of_motion}
\end{align}
and for the defocusing case ($K<0$) become
\begin{align}
C\left(s\right) &= \cosh\left(\left|K\right|s\right), \nonumber \\
S\left(s\right) &= \frac{1}{\sqrt{\left|K\right|}}\sinh\left(\left|K\right|s\right).
\label{eq:defocusing_solution_equation_of_motion}    
\end{align}
Generalising for each plane $u\left(s\right)\equiv x\left(s\right) \parallel z\left(s\right)$ the solutions become
\begin{align}
u\left(s\right) &= aC\left(s\right) + bS\left(s\right) + \frac{\Delta p}{p_{0}}D\left(s\right), \nonumber \\
u'\left(s\right) &= aC'\left(s\right) + bS'\left(s\right) + \frac{\Delta p}{p_{0}}D\left(s\right),
\label{eq:generalised_solution}
\end{align}
where $D\left(s\right)$ is the dispersion function (see Section \textcolor{blue}{**LINK**}), which accounts for the effect of momentum on particle trajectories and $a$, $b$ are coefficients related to the initial conditions of the particles. Commonly, for convenience, the solution (Eq.~\ref{eq:generalised_solution}) to the equations of motion is expressed in matrix formalism
\begin{equation}
\begin{pmatrix}
u\left(s\right) \\
u'\left(s\right) \\
\Delta p/p_{0}
\end{pmatrix} = 
\begin{pmatrix}
C\left(s\right) & S\left(s\right) & D\left(s\right) \\
C'\left(s\right) & S'\left(s\right) & D'\left(s\right) \\
0 & 0 & 1
\end{pmatrix}
\begin{pmatrix}
u\left(s_{0}\right) \\
u'\left(s_{0}\right) \\
\Delta p/p_{0}
\end{pmatrix},
\label{eq:general_solution_matrix}    
\end{equation}
where $s_{0}$ is the initial longitudinal position of the particle.

\section{Transport Matricies} 
\textcolor{blue}{**EXPLAIN 6D CO-ORDINATE SYSTEM**\\}

\subsection{Drift Space}

\subsection{Quadrupole Magnet}



\subsection{Dipole Magnet}

\section{Twiss Parameters and Emittance}
\textcolor{blue}{**INCLUDE DISPERSION**}

\section{Tune and Chromaticity}

\section{RF Acceleration}

\section{Longitudinal Dynamics}

\section{Linear Lattices}
\textcolor{blue}{**FODO Lattice** \\ **MBA** \\ **FFAG**}

\section{Description of an Energy Recovery Linac}

\textcolor{blue}{**HOLZER'S TRASVERSE BEAM DYNAMICS A GOOD STARTING POINT**}

\textcolor{blue}{\begin{itemize}
    \item{Need to explain a photoinjector and an injector cryomodule}
    \item{Explain particle acceleration better}
    \item{Why is SRF currently preferred?
        \begin{itemize}
            \item{beam current considerations} 
        \end{itemize}}
    \item{single pass ERL}
    \item{multi-pass ERL}
    \item{transport options}
    \item{Dual linac ERLs
        \begin{itemize}
            \item{Asymmetry of linacs etc.}
            \item{what are the benefits?}
        \end{itemize}}
    \item{beam loading}
    \item{push-pull linacs}
\end{itemize}}

\subsection{Single Turn ERL}

Within this first order explanation of an energy recovery linac we consider, for simplicity, the case of a single turn electron ERL, with a single linac. Firstly, the electron bunches are injected typically by a high energy photoinjector and injector accelerator section to an electron beam kinetic energy of 5--10~\si{\mega\electronvolt} with a small emittance either operating in a burst mode, in which a train of bunches is injected with intermittent pauses, or in continuous wave (CW) mode where pulses are injected with a fixed bunch spacing. These particle bunches are then delivered in suitable configuration to a linac, a series of consecutive radio-frequency (RF) accelerating cavities, which accelerate the particle bunch via a generated electric field to some nominal energy. For an ERL either normal conducting RF (NCRF) or superconducting radio-frequency RF (SRF) accelerating cavities can be utilised. The accelerating electromagnetic field in an RF cavity produces a standing wave of wavelength $\lambda_{\mathrm{RF}}$ with a potential difference that is sinusoidally varying in position and time. Therefore, to accelerate the electron bunch it's transit of the cavity must coincide with near-peak voltage of the electric field.   

The particle bunch accelerated to nominal energy is then transported through a return beamline (return loop) consisting of a series of magnets which confine the electron bunch and return it to the linac. During transport the electron bunch could be utilised for a variety of applications, such as driving a light source, or for collider experiments as envisioned in Tigner's original design \cite{tigner1965possible}.

The electron bunch must have a path length of $\left(w+\frac{1}{2}\right)\lambda_{\mathrm{RF}}$, where $w$ is an integer, through the return beamline because this will determine that the electron bunch re-enters the linac at a trough in the potential difference ensuring the particle bunch is decelerated. The kinetic energy of the electron bunch is transferred to the electric field of the accelerating cavities within this deceleration and therefore recovered for acceleration of a subsequent bunch. The initial electron bunch is then transported to a beam stop.

When the energy imparted to the electron beam by an RF cavity is recovered by the identical RF cavity upon deceleration this is termed same cell energy recovery. Several different schemes can exist where energy imparted by a particular RF cavity is recovered by a different RF cavity or the energy used to accelerate an electron bunch is only partially recovered by an RF cavity. Schematics of energy recovery can be further complicated when there are multiple linac sections within an energy recovery linac and complexity is compounded when these are of asymmetric length.     

\subsection{Multi-pass ERL}

Multi-pass ERLs are a prominent subject within this manuscript, these operate differently from single turn ERLs as there are consecutive accelerating passes of the linac, as in a recirculating linac \cite{axel1977status}, followed by consecutive decelerating passes of the linac. In a multi-pass ERL the electron bunch is injected into the linac and is accelerated to the first nominal energy, then transported to the linac via a return beamline. However, we differ from a single turn ERL here as the return beamline must have a path length of $w\lambda_{\mathrm{RF}}$ in order for the electron bunch to coincide with the peak of the accelerating field and therefore be re-accelerated to the next nominal energy.

The acceleration can occur for an unbounded total of $\frac{m}{2}$ passes before the return beamline must conform to the $\left(w+\frac{1}{2}\right)\lambda_{\mathrm{RF}}$ path length condition; a phase change of 180\si{\degree} relative to the electromagnetic wave of the linac RF cavities which converts the electron bunch into a decelerating configuration. A series of $\frac{m}{2}$ decelerating passes then returns the bunch to its injection energy via a total of $m$ linac passes. The decelerating passes must have a path length obeying the $w\lambda_{\mathrm{RF}}$ condition as the bunch is already in the decelerating configuration and therefore must maintain a path length of integer RF wavelengths in order for the electron bunch to coincide with the troughs of the RF cavity electromagnetic wave. Once the electron bunch has returned to the injection energy it is transported to the beam stop. Each deceleration recovers energy for the subsequent electron bunch to be accelerated.        

Here we define the convention that an acceleration and later deceleration is termed a turn and that a single traversal of the linac is termed a pass, accelerating or otherwise. For example for a single linac two turn ERL, the electron bunch is accelerated by the linac twice, resulting in two nominal energies, then decelerated by the linac twice, however the electron bunch is returned to the linac only three times. An $n$ turn single linac ERL involves $m$ passes of the linac and requires $m-1$ traversals of a return beamline before the electron bunch is transported to the beam stop, corresponding to $n$ nominal energies of the ERL.   

\subsection{Multi-pass Electron Transport}

The requirement upon multi-pass ERLs to have multiple return beamlines which have to be in either accelerating or decelerating configuration and operate at several nominal energies enables a variety of solutions to beam transport. The simplest solution conceptually is to have a separate return transport for each individual pass, termed separate transport. This allows for independence in specification of each beamline, with both each nominal energy electron bunch having its own beamline and flexibility between accelerating and decelerating passes. However, separate transport means that $m-1$ beamlines must be configured to transport the electron beam from and to the linac which results in complicated spreader systems with challenging space considerations. Requiring multiple beamlines also increases cost of an ERL and in practice neighbouring beamlines can affect each other.

Within common transport, the accelerating and decelerating passes for each nominal energy that is traversed twice (i.e all but the maximum nominal energy) share a common return transport. This is possible since after the electron beam has been converted to the decelerating configuration on the maximum nominal energy pass (traversed only once) the path length condition $w\lambda_{\mathrm{RF}}$ is identical for the other nominal energies for accelerating and decelerating passes. However, the properties of the electron bunch do not remain invariant between accelerating and decelerating passes therefore the common transport return beamlines are doubly constrained. The advantage of this approach is that only $n$ transport beamlines are required, which reduces cost and the difficulty in design of spreader switch-yards where the beamlines feed into the entrance and exit of the linac.   
Another solution exists wherein multiple nominal energy electron beams in both accelerating and decelerating configuration are transported within the same beamline. To distinguish this from common transport we term this approach multi-energy common transport, This has been demonstrated \cite{bartnik2020cbeta} using a fixed field alternating gradient beamline. However, to operate a multi-pass ERL with a multi-energy common transport the matching constraints of this beamline are $m-1$ fold and the required phase change must be designed into the beamline. There is little room for error in this approach as correction or path length or optics has consequences for every other return pass. Hence, these are often utilised with a common transport spreader arrangement at the entrance and exit of the linac, though these are also highly constrained beamlines. The multi-energy common transport approach is advantageous as potentially only a single beamline need be afforded and theoretically, if all constraints can be satisfied, this avoids the need of a spreader system.  

\section{Collective Effects}

\subsection{Beam Breakup Instability}

The average beam current off energy recovery linacs can be seriously limited by the effects of the beam breakup instability (BBU). Average beam current limitations are challenging for inverse Compton scattering source development with ERL drivers because of the dependency of flux upon electron beam average current. Therefore, this collective effect has substantial consequences for the design of ERL driven ICS sources.

In the beam breakup instability, the electron bunch interacts with a higher order mode (HOM) of the accelerating structure and is subsequently deflected. Electron bunches with a transverse offset traverse an RF cavity and excite a HOM within the cavity. The electron bunch subsequently recieves a transverse kick, thereby generating a further higher order mode due to the transverse offset the kick generates. Beyond some threshold current value $I_{\mathrm{th}}$ this process becomes exponential in nature resulting in beam loss.

Two forms of beam breakup exist; cumulative BBU in which the instability builds up over a series of RF accelerating structures, for example a long (100's~\si{\meter}) linac, and regenerative BBU where the effect build up via multiple passes of the same RF cavity. The former of these was the observed first, with experimentation at SLAC \cite{panofsky1966electrons,altenmueller1966beam} and LLNL \cite{neil1970coherent} and analytically modelled by Panofsky and Bander et al \cite{panofsky1968asymptotic}. However, for ERLs -- especially multi-turn ERLs -- regenerative beam breakup instability is of greater concern due to the recirculated nature of the accelerator in which a short linac section is typical.

Regenerative BBU is particularly present in multi-turn ERLs in comparison to circular machines such as synchrotrons for several reasons for example, the multiple energy bunches in the ERL are deflected differently for the same HOM voltage causing variation in bunch transverse offsets and the change in revolution time for the first decelerating bunch in which the phase is modulated by 180\si{\degree} \cite{setiniyaz2021filling}.

Theoretical studies of regenerative BBU in ERL's were conducted by Hoffstaetter and Bazarov \cite{hoffstaetter2004beam} for uncoupled optics, then furthered for the case of coupled optics \cite{hoffstaetter2007recirculating}. The focus here is typically on the excitation of dipole higher order modes \textcolor{blue}{Why?} Experimentally, regenerative BBU was observed and studied in an ERL at the Jefferson Laboratory FEL \cite{tennant2005first,douglas2006experimental}. \textcolor{blue}{What did this show?} Here conventional methods of suppressing BBU \cite{tennant2004methods} in an ERL, such as HOM dampeners, are explored as well as accelerator optics based solutions \cite{rand1980beam}. 

Recently BBU studies have been performed for the CBETA ERL \cite{lou2019beam}, one of the main accelerators of interest within this work, which have predicted a restrictive average beam current limitation of $I_{\mathrm{th}} = 40$~\si{\milli\ampere}. However, mitigation of regenerative BBU remains an active field exemplified by the proposal of a bunch filling pattern which could increase the threshold current limitation by up to a factor of 5 for a 3-turn ERL \cite{setiniyaz2021filling}.    

\end{document}