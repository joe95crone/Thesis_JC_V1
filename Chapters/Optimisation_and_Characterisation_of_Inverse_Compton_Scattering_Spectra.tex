%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Doctoral Thesis Template @ The University of Manchester
% LaTeX Chapter Template
% Version 1 (23/07/2020)
% Joe Crone
%
% This template is based on:
% The University of Manchester, Presentation of Thesis Policy
% Research Office Graduate Education Team
% June 2017
% http://www.regulations.manchester.ac.uk/pgr-presentation-theses/
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[../main.tex]{subfiles}
\begin{document}

% Title
%--------------------------------------------------------
\chapter{Optimisation and Characterisation of Inverse Compton Scattering Spectra}
\label{Optimisation_and_Characterisation_of_Inverse_Compton Scattering_Spectra} % to reference use \ref{ChapterTemplate}

\section{Motivation for Characterisation of ICS Sources}

Proper characterisation of inverse Compton scattering sources is necessary to quantify source performance for reliable comparison of sources. Through design and benchmarking of models to predict ICS source performance, understanding of the interaction is gained which can show routes to improving narrowband ICS source design such as the optimisation strategies covered later in this chapter, which were motivated by the characterisation work. Unlike the spectral output parameters presented in Chapter~\ref{Photon_Production_by_Inverse_Compton_Scattering}, which show only a snapshot of source performance, models need to be designed to take into account collimation and account for all necessary effects such as energy spread and emittance effects present in the spectrum. This allows the spectrum of the radiation produced by an ICS source to be predicted and therefore users can understand the experimental probe used in their light source experiments.

Within the first half of this chapter, an analytical approach to calculating the collimated flux produced by an ICS source is developed and compared to existing methods \cite{curatolo2017analytical} and a semi-analytical spectrum code \textsc{ICARUS}: inverse Compton scattering semi-analytical recoil-corrected ultra-relativistic spectrum code based on the model by Sun et al \cite{sun2009characterizations,sun2011theoretical}, which is corrected and expanded, is developed and benchmarked using the \textsc{ICCS3D} code \cite{krafft2016laser,ranjan2018simulation}. The characterisation methods developed here are tested by several cases outlined in Section~\ref{sec:benchmarking_cases_characterisation_optimisation} to encapsulate the range of typical drivers of inverse Compton scattering source, not limiting this work to ERLs alone.

\textcolor{blue}{**WHY DEV AN ANALYTICAL COLLIMATED FLUX \\**}
An analytical collimated flux equation has been developed in Section~\ref{sec:analytical_collimated_flux} in order to provide a quick, reliable method to predict the yield of spectrum codes. Using this method, more accurate simulations such as those from the \textsc{ICAURUS} spectrum code can be evaluated. A wide variety of effects such as collimation, angular crossing and hourglass effects have been incorporated into this methodology, with the notable neglection of the effect of energy spread of the electron bunch and spectral bandwidth of the laser pulse. Large-scale spectrum code simulations require computational time on the order of hours, with parallel computing whereas analytical calculations can be evaluated in sub-second timescales. Therefore, analytical collimated flux calculations are easier to apply to optimisation procedures rather than the more accurate spectral yield calculations from spectrum codes.   

\textcolor{blue}{**WHY CHOSE SEMI-ANALYTICAL MODEL**\\}
The \textsc{ICARUS} spectrum code is a dedicated semi-analytical inverse Compton scattering codes unlike the standard ICS source Monte Carlo simulation code \textsc{CAIN} \cite{chen1995cain}, which simulates electromagnetic interactions with subroutines to limit the code only to the ICS interaction. A semi-analytical ICS spectrum code is advantageous to Monte Carlo based techniques such as the \textsc{CAIN}  spectrum code as  collimation effects aren't taken into account within the simulation and are instead required as part of post-simulation analysis. Because \textsc{CAIN} treats the incident laser pulse as an electric field, the effect of the spectral bandwidth of the pulse isn't properly accounted for which is necessary for the ICS interaction where this can be the main contributor to the bandwidth of the resulting spectrum. Inherently, in Monte Carlo simulation rare events in nature will be as rare in the simulation, therefore statistics in situations where low scattered photon counts are expected are poor; for example in the tails of the distribution, at very narrow apertures \cite{ranjan2018simulation} and in re-circulated ICS sources where low flux interactions are conducted at high repetition rate. 

\section{Analytical Collimated Flux}
\label{sec:analytical_collimated_flux}

In this section, the collimated flux - the total flux collected within an aperture of semi-angle $\theta_{\mathrm{col}}$ is derived from first principles, using the work of Berestetskii et al \cite{berestetskii1982quantum}. This method, unlike others in the literature \cite{curatolo2017analytical}, is valid for the angular crossing case ($\phi\in\mathbb{R}$) as the effect of the crossing angle is encompassed in the cross section alongside the geometric beam--beam angular crossing effect. The hourglass effect is also fully accounted for in this method, using the prescription of Miyahara \cite{miyahara2008luminosity}. The collimated flux calculation method is a semi-analytic calculation that is valid within the recoil regime (above $X\ll1$) but is only valid for the linear inverse Compton scattering case ($a_{0}\ll1$).

In order to find the scattering angle $\theta$ dependence of the cross section \textcolor{blue}{link to cross section derivation/work} we must focus on the dependence of the scattering angle on the Lorentz invariant quantities ($X$ and $Y$) (Eq.~\ref{eq:X_geometry},~\ref{eq:Y_geometry}) derived from Mandelstam variables in Section~\ref{sec:electron_photon_interactions}. Intrinsically, our definition of the recoil parameter $X$ (Eq.~\ref{eq:X_Mandelstam}) relates to the centre of mass $s$ Mandelstam variable before the interaction, so there is no scattering angle  dependence. The $Y$ Lorentx invariant is dependent on $\theta$, to include it's scattering angle dependence we must examine the derivative of $Y$ with $\theta$. Inspecting (Eq.~\ref{eq:Y_geometry}) we see $Y$ is also dependent on $E_{\gamma}$, the scattered photon energy (Eq.~\ref{eq:scattered_photon_energy}) derived in Section~\ref{sec:derivation_of_the_scattered_photon_energy}, which is also dependent on scattering angle. Thus, we must first expand $Y$ which can be simplified in terms of the recoil parameter $X$ (Eq.~\ref{eq:X_geometry})
\begin{equation}
Y = \frac{2\gamma E_{L}\left(1+\beta\cos\phi\right)\left(1-\beta\cos\theta\right)}{m_{e}c^{2}\left\{1-\beta\cos\theta+\left[1+\cos\left(\phi+\theta\right)\right]E_{L}/E_{e}\right\}} = \frac{X\left(1-\beta\cos\theta\right)}{1-\beta\cos\theta+\left[1+\cos\left(\phi+\theta\right)\right]E_{L}/E_{e}}.
\label{eq:Y_geometry_expanded}
\end{equation}
For our purposes, we require the derivative of $Y$ with respect to $\theta$. The derivative of our expanded $Y$ Lorentz invariant (Eq.~\ref{eq:Y_geometry_expanded}) is best found using the quotient rule  
\begin{gather}
Y\left(\theta\right) = \frac{g\left(\theta\right)}{h\left(\theta\right)}, \\
\frac{dY\left(\theta\right)}{d\theta} = \frac{g'\left(\theta\right)h\left(\theta\right)-g\left(\theta\right)h'\left(\theta\right)}{\left[h\left(\theta\right)\right]^{2}},
\label{eq:quotient_rule}
\end{gather}
where the terms in (Eq.~\ref{eq:quotient_rule}) are given by
\begin{gather}
g\left(\theta\right) = X\left(1-\beta\cos\theta\right), \\
g'\left(\theta\right) = X\beta\sin\theta, \\
h\left(\theta\right) = 1-\beta\cos\theta+\left[1+\cos\left(\phi+\theta\right)\right]E_{L}/E_{e}, \\
h'\left(\theta\right) = \beta\sin\theta-\sin\left(\phi+\theta\right)E_{L}/E_{e}.
\label{eq:quotientterms}
\end{gather}
The full derivative of $Y$ by $\theta$ is therefore
\begin{equation}
\frac{dY}{d\theta} = \frac{X\beta\sin\theta\left\{1-\beta\cos\theta+\left[1+\cos\left(\phi+\theta\right)\right]E_{L}/E_{e}\right\}-X\left(1-\beta\cos\theta\right)\left[\beta\sin\theta-\sin\left(\phi+\theta\right)E_{L}/E_{e}\right]}{\left\{1-\beta\cos\theta+\left[1+\cos\left(\phi+\theta\right)\right]E_{L}/E_{e}\right\}^{2}}.
\label{eq:dY_dtheta}
\end{equation}

\begin{figure}[!h]
\centering
\includegraphics[width=\textwidth]{Figures/Photon_Production_by_Inverse_Compton_Scattering/SunPolarisationScatteringDiagram.pdf}
\caption{Left: The 3D scattering geometry of the electron - photon interaction by C. Sun \cite{sun2009characterizations}. Here $\phi_{f}$ is the azimuthal angle of the scattered photon and $\tilde{x}, \tilde{y}, \tilde{z}$ define the co-ordinate system of the incident electron and the notation is varied $p = p_{1}$, $k = k_{1}$ and $k' = k_{2}$. Right: Interaction polarisation diagram by C. Sun \cite{sun2009characterizations}. Here $\tau$ is the azimuthal angle of the polarization vector $\epsilon$.\textcolor{blue}{**NEED TO REPLACE DIAGRAM**}}
\label{fig:sun_geometry}
\end{figure}

Since we understand that the cross section's \textcolor{blue}{Link to the cross section section} scattering angle dependence is due to the $Y$ Lorentz invariant, as this is constructed from both Lorentz invariants and the $X$ invariant (Eq.~\ref{eq:X_geometry}) which is defined without scattering angle dependence, we must find the dependence of the cross section on the Lorentz invariant $Y$ in order to propagate the full dependencies. \textcolor{blue}{**some of this is required in the cross section section**} Fig.~\ref{fig:sun_geometry} shows the full 3D geometry of the electron - phton interaction, which includes a polarisation diagram. Following Eq. (2.27) by Sun \cite{sun2009characterizations}, we can then use a standard result from QED for the cross section of the interaction of unpolarised electron beam and polarised laser pulse, without considering the post-interaction polarisations \cite{grozin2002complete} \textcolor{blue}{Did this just stay as an arXiv paper?}
\begin{equation}
\frac{d^{2}\sigma}{dYd\phi_{f}} = \frac{4r_{e}^{2}}{X^{2}}\left\{\left(1-\xi_{3}\right)\left[\left(\frac{1}{X}-\frac{1}{Y}\right)^{2}+\frac{1}{X}-\frac{1}{Y}\right]+\frac{1}{4}\left(\frac{X}{Y}+\frac{Y}{X}\right)\right\},
\label{eq:differential_cross_section_Y_phif}
\end{equation}
where $\phi_{f}$ is the azimuthal angle of the scattered photon, $r_{e}$ is the classical electron radius, $X$ and $Y$ are the Lorentz invariants in (Eq.~\ref{eq:X_geometry}, \ref{eq:Y_geometry}) and $\xi_{3}$ is the Stokes parameter, describing linear polarisation aligned to the $x$ or $y$ axis, given by
\begin{equation}
\xi_{3} = -P_{t}\cos\left(2\tau-2\phi_{f}\right),
\label{eq:stokes_3}
\end{equation} 
with $0 \leq P_{t} \leq 1$, the degree of linear polarisation and $\tau$ the azimuthal angle of the polarisation vector. 

We can then integrate over the azimuthal scattering angle $\phi_{f}$
\begin{equation}
\frac{d\sigma}{dY} = \frac{4r_{e}^{2}}{X^{2}}\int_{0}^{2\pi}\left[1+P_{t}\cos\left(2\tau-2\phi_{f}\right)\right]\left\{\left(1-\xi_{3}\right)\left[\left(\frac{1}{X}-\frac{1}{Y}\right)^{2}+\frac{1}{X}-\frac{1}{Y}\right]+\frac{1}{4}\left(\frac{X}{Y}+\frac{Y}{X}\right)\right\} d\phi_{f}, 
\label{eq:phif_integral}
\end{equation}
we can then take the case of an unpolarised laser pulse or a circularly polarised laser pulse ($P_{t} = 0$), or acknowledge that this polarisation term becomes zero once integrated over the full azimuthal angle $\phi_{f}$, to simplify this to
\begin{equation}
\frac{d\sigma}{dY} = \frac{8\pi r_{e}^{2}}{X^{2}}\left\{\left[\left(\frac{1}{X}-\frac{1}{Y}\right)^{2}+\frac{1}{X}-\frac{1}{Y}\right]+\frac{1}{4}\left(\frac{X}{Y}+\frac{Y}{X}\right)\right\},
\label{eq:cross_section_Y_berestetskii_form}
\end{equation}
which replicates the form in Eq. (86.16) by Berestetskii et al \cite{berestetskii1982quantum}.

The dependence of the cross section $\sigma$ upon the scattering angle $\theta$ can be found using the chain rule
\begin{equation}
\frac{d\sigma}{d\theta} = \frac{d\sigma}{dY}\frac{dY}{d\theta}.
\label{eq:cross_section_chain_rule}
\end{equation}
Therefore, the cross section for a collimation angle $\theta_{\mathrm{col}}$ becomes
\begin{equation}
\sigma\left(\theta_{\mathrm{col}}\right) = \int_{0}^{\theta_{\mathrm{col}}}\frac{d\sigma}{dY}\frac{dY}{d\theta}d\theta,
\label{eq:cross_section_integral}
\end{equation} 
where $\frac{d\sigma}{dY}$ is given by (Eq.~\ref{eq:cross_section_Y_berestetskii_form}) and $\frac{dY}{d\theta}$ is given by (Eq.~\ref{eq:dY_dtheta}). The full cross section calculation is summarised as
\begin{multline}
\sigma\left(\theta_{\mathrm{col}}\right) = \int_{0}^{\theta_{\mathrm{col}}} \frac{8\pi r_{e}^{2}}{X^{2}}\left\{\left[\left(\frac{1}{X}-\frac{1}{Y}\right)^{2}+\frac{1}{X}-\frac{1}{Y}\right]+\frac{1}{4}\left(\frac{X}{Y}+\frac{Y}{X}\right)\right\}\\\frac{X\beta\sin\theta\left\{1-\beta\cos\theta+\left[1+\cos\left(\phi+\theta\right)\right]E_{L}/E_{e}\right\}-X\left(1-\beta\cos\theta\right)\left[\beta\sin\theta-\sin\left(\phi+\theta\right)E_{L}/E_{e}\right]}{\left\{1-\beta\cos\theta+\left[1+\cos\left(\phi+\theta\right)\right]E_{L}/E_{e}\right\}^{2}}d\theta,
\label{eq:full_scattering_angle_cross_section_integral}
\end{multline}
where $Y, X, E_{\gamma}$ are of the forms in (Eq.~\ref{eq:Y_geometry},~\ref{eq:X_geometry},~\ref{eq:scattered_photon_energy}). Using the results derived in Sections~\ref{sec:luminosity_and_flux},~\ref{sec:angular_crossing_and_hourglass_effects} the collimated flux is given by a modified cross section (Eq.~\ref{eq:full_scattering_angle_cross_section_integral}) form of the flux equation (Eq.~\ref{eq:headon_flux}), with an angular crossing and the  hourglass effect taken into account (Eq.~\ref{eq:flux_angular_crossing_hourglass})
\begin{equation}
\mathcal{F}_{\mathrm{col}} = \sigma\left(\theta_{\mathrm{col}}\right) R_{ACHG}\mathcal{L}_{\mathrm{HEAD-ON}}f.
\label{eq:collimated_flux}
\end{equation}

It is inherent in (Eq.~\ref{eq:collimated_flux}) that the interaction occurs from a point source - the transverse and longitudinal positions of the electrons within the bunch are neglected. This is a common approximation in both simulations and in all presented flux formulae.

Within (Eq.~\ref{eq:collimated_flux}) the effect of the energy spread of the bunch, the laser pulse energy spread (spectral bandwidth) and partially, via the point source approximation, the effect of the emittance (spatial extent) of the bunch are neglected. The geometry consideration of the spatial extent of the bunch is taken into account via the luminosity reduction factors, but not the offset in emission position which would affect whether the photon passes the collimator. The codes \textsc{ICARUS} and \textsc{ICCS3D} \cite{krafft2016laser,ranjan2018simulation} properly take into account the energy spread factors but the emission position problem is only solved in Monte Carlo codes such as \texsc{CAIN} \cite{chen1995cain}. However, this effect is expected to be small as the source is dependent on far-field collimation. Far-field collimation is applicable when the transverse size of the electron bunch - laser pulse overlap is negligible in relation to the aperture of the collimator. 

\section{Development of the ICARUS Spectrum code}
\label{sec:development_of_the_ICARUS_spectrum_code}

\textcolor{blue}{\\\textbf{**TO DO**}\\ **CHECK THE MATHS AND SHORE UP THE DERIVATION WITH ADDITIONAL EXPLANATION OF ASSUMPTIONS**\\ **MAYBE INCLUDE DIAGRAMS EXPLAINING THE INTERACTION AND THE GEOMETRY ETC.**}  

\textsc{ICARUS}: inverse Compton scattering semi-analytic recoil-corrected ultra-relativistic spectrum code, uses a modified and corrected  version of the 2D formalism of Sun et al. \cite{sun2009characterizations,sun2011theoretical} to generate the spectrum of radiation produced by an ICS source operating in the linear regime ($a_{0}\ll 1$). \textsc{ICARUS} calculates the number of photons produced at small energy intervals that pass through a given far-field 2D collimator aperture (circular or rectangular) for the fundamental laser mode. The produced radiation spectrum is the observable ICS spectrum at a detector placed downstream of a collimator. The model assumes that the electron bunch has a 3D Gaussian distribution, approximates the laser as a 3D Gaussian pulse, can account for both circular and linear polarised incident photons and is currently only valid for the head-on ($\phi = 0$) geometry.

Using the result of Sun et al \cite{sun2009characterizations,sun2011theoretical}, the spatial and energy distributions of a $\gamma$-ray beam produced by a head-on collision of an electron bunch and laser pulse is given by
\begin{multline}
\frac{dN_{\gamma}}{d\Omega_{c} dE_{\gamma}} = N_{e}N_{L}\int \frac{d\sigma}{d\Omega}\delta\left(\bar{E_{\gamma}}-E_{\gamma}\right)c\left(1+\beta\right)f_{e}\left(x,y,z,x',y',p,t\right)\\ \times f_L\left(x,y,z,k,t\right)dx'~dy'~dp~dk~dV~dt,
\label{eq:central_distribution_sun}
\end{multline}
where the collimator solid angle is $d\Omega_{c} = dx_{c}dy_{c}/L^{2}$ with $x_{d}$ and $y_{d}$ the $x$ and $y$ positions at the collimator and $L$ the source-to-collimator distance, $\frac{d\sigma}{d\Omega}$ is the differential cross section of the ICS interaction, $\delts\left(\bar{E_{\gamma}}-E_{\gamma}\right)$ is a delta function which encapsulates energy conservation in the process with $\bar{E_{\gamma}}$ the maximum possible energy a $\gamma$-ray have for a scattering angle $\theta$ and $E_{\gamma}$ the actual $\gamma$-ray energy, the $c\left(1+\beta\right)$ term arises from the Doppler shifting of the radiation, $f_{e}$ and $f_{L}$ are the phase-space intensity distributions of the electron bunch (Eq.~\ref{eq:electron_gaussian_intensity_distribution}) and laser pulse (Eq.~\ref{eq:laser_gaussian_intensity_distribution}) as modelled by Gaussian distributions, $dx'$ and $dy'$ are the divergence integration variables in $x$ and $y$ respectively, $dp$ is momentum of the electron integration variable, $dk$ is the wavenumber of the laser pulse integration variable, $dV$ is the volume of the interaction integration parameter and  $dt$ is the interaction time integration variable. 

The differential cross section for a head-on collision in this model is given by
\begin{equation}
\frac{d\sigma}{d\Omega} = 8r_{e}^{2}\left\{\frac{1}{4}\left[\frac{4\gamma^{2}E_{L}}{\bar{E_{\gamma}}\left(1+\gamma^{2}\theta^{2}\right)}+\frac{\bar{E_{\gamma}}\left(1+\gamma^{2}\theta^{2}\right)}{4\gamma^{2}E_{\gamma}}\right]-2\cos^{2}\left(\tau-\phi_{f}\right)\frac{\gamma^{2}\theta^{2}}{\left(1+\gamma^{2}\theta^{2}\right)^{2}}\right\}\left(\frac{\bar{E_{\gamma}}}{4\gamma E_{L}}\right)^{2},
\label{eq:sun_differential_cross_section}    
\end{equation}
where $\bar{E_{\gamma}}$ is the Compton edge energy for a particular scattering angle $\theta$ in the small angle approximation for a head-on ($\phi=0$) collision
\begin{equation}
\bar{E_{\gamma}} = \frac{4\gamma^{2}E_{L}}{1+\gamma^{2}\theta^{2}+\frac{4\gamma E_{L}}{m_{e}c^{2}}}.
\label{eq:sun_Egamma_bar}    
\end{equation}
We can then express the angular divergences $x'$ and $y'$ by the projection of the scattering angle of of the produced radiation in each plane $\theta_{x}'$ and $\theta_{y}'$ ($\theta = \sqrt{\theta_{x}^{2}+\theta_{y}^{2}}$), whilst neglecting the very small angular divergences of the laser pulse, using the relations
\begin{align}
\theta_{x}' + x' &= \frac{x_{c}-x}{L}, \\
\theta_{y}' + y' &= \frac{y_{c}-y}{L}
\label{eq:sun_angular_divergence}    
\end{align}
which arise from the geometric constraints of a photon passing through a collimator and then impinging on a detector in far-field collimation ($L \gg \sqrt{x_{c}^{2}+y_{c}^{2}}$), where $x$ and $y$ are the positions of the interaction in each plane. We typically assume $x=y=0$ because we assume a point source. The model can be extended for collimator misallignment simply through addition of a simple error term \cite{sun2009characterizations} $x/y_{\mathrm{err}}$, where the angular divergences become
\begin{align}
\theta_{x}' + x' &= \frac{x_{c}-x-x_{\mathrm{err}}}{L}, \\
\theta_{y}' + y' &= \frac{y_{c}-x-x_{\mathrm{err}}}{L}
\label{eq:sun_collimator_misallignment}    
\end{align}
Applying (Eq.~\ref{eq:sun_angular_divergence}) and integrating (Eq.~\ref{eq:central_distribution_sun}) with respect to $dV$, the interaction geometric volume and $dt$ the interaction time, whilst expanding the detector solid angle and the Gaussian intensity distributions of the electron bunch (Eq.~\ref{eq:electron_gaussian_intensity_distribution}) and laser pulse (Eq.~\ref{eq:laser_gaussian_intensity_distribution}), we gain
\begin{multline}
\frac{dN_{\gamma}}{dE_{\gamma}dx_{d}dy_{d}} = \frac{N_{e}N_{L}}{\left(2\pi\right)^{3}z_{R}\sigma_{p}\sigma_{k}}\int \frac{k}{\sqrt{\zeta_{x}\zeta_{y}}\sigma_{\theta_{x}}\sigma_{\theta_{y}}}\frac{d\sigma}{d\Omega}\delta\left(\bar{E_{\gamma}}-E_{\gamma}\right)\left(1+\beta\right) \\\times\exp\left[-\frac{\left(\theta_{x}-x_{d}/L\right)^{2}}{2\sigma_{\theta_{x}}^{2}}-\frac{\left(\theta_{y}-y_{d}/L\right)^{2}}{2\sigma_{\theta_{y}}^{2}}-\frac{\left(p-p_{0}\right)^{2}}{2\sigma_{p}^{2}}-\frac{\left(k-k_{0}\right)^{2}}{2\sigma_{k}^{2}}\right]~d\theta_{x}~d\theta_{y}~dp~dk,
\label{eq:sun_volume_time_integral}    
\end{multline}
where $z_{R}$ is the Rayleigh range \textcolor{blue}{**reference once sorted Compton theory**}, the $\zeta_{x/y}$, $\sigma_{\theta_{x/y}}$ and  $\xi_{x/y}$ parameterisations in each plane are given by
\begin{align}
\zeta_{x} &= 1+\frac{2k\beta_{x}\epsilon_{x}}{z_{R}}, & \sigma_{\theta_{x}} &= \sqrt{\frac{\epsilon_{x}\xi_{x}}{\beta_{x}\zeta_{x}}}, & \xi_{x} &= 1+\left(\alpha_{x}-\frac{\beta_{x}}{L}\right)^{2}+\frac{2k\beta_{x}\epsilon_{x}}{z_{R}}, \nonumber\\
\zeta_{y} &= 1+\frac{2k\beta_{y}\epsilon_{y}}{z_{R}}, & \sigma_{\theta_{y}} &= \sqrt{\frac{\epsilon_{y}\xi_{y}}{\beta_{y}\zeta_{y}}}, & \xi_{y} &= 1+\left(\alpha_{y}-\frac{\beta_{y}}{L}\right)^{2}+\frac{2k\beta_{y}\epsilon_{y}}{z_{R}}, 
\label{eq:zeta_sigmatheta_xi_parameters_sun}
\end{align}
where $p_{0}$ is the centroid momentum of the electron bunch and $k_{0}$ is the centroid wavenumber of the laser pulse. Here note that there is an algebraic error in Sun et al's \cite{sun2009characterizations,sun2011theoretical} derivation, the prefactor gives that $dN/dE\propto L^{2}$ for a source-to-collimator distance $L$. This arises due to a mishandling of the detector solid angle. Clearly, this should be $dN/dE\propto 1/L^{2}$, meaning there is an inverse square relationship between source-to-collimator distance and the spectral density as would be expected. 

The delta function, encompassing the energy conservation of this process can be re-wrote in terms of the Lorentz factor
\begin{equation}
\delta\left(\bar{E_{\gamma}}-E_{\gamma}\right) = -\delta\left(\gamma-\bar{\gamma}\right)\frac{\left(1+\bar{\gamma}^{2}\theta^{2}+\frac{4\bar{\gamma}E_{L}}{m_{e}c^{2}}\right)^{2}}{8\bar{\gamma}E_{L}\left(1+\frac{2\bar{\gamma}E_{L}}{m_{e}c^{2}}\right)},
\label{eq:sun_electron_energy_delta_function}    
\end{equation}
where $\bar{\gamma}$ is the route of $\bar{E_{\gamma}}$ (Eq.~\ref{eq:sun_Egamma_bar}) as given by
\begin{equation}
\bar{\gamma} = \frac{2E_{\gamma}E_{L}}{m_{e}c^{2}\left(4E_{L}-E_{\gamma}\theta^{2}\right)}\left[1+\sqrt{1+\frac{4E_{L}-E_{\gamma}\theta^{2}}{4E_{L}^{2}E_{\gamma}/\left(m_{e}c^{2}\right)^{2}}}\right].    
\end{equation}

Substituting for $\delta\left(\bar{E_{\gamma}-E_{\gamma}}\right)$ using (Eq.~\ref{eq:sun_electron_energy_delta_function}) and changing the electron bunch momentum variable from $dp$ to $d\gamma$, we can then integrate (Eq.~\ref{eq:}) over $d\gamma$ to introduce the electron bunch energy spread variation which gives
\begin{multline}
\frac{dN_{\gamma}}{dE_{\gamma}} = \frac{r_{e}^{2}N_{e}N_{L}}{4\pi^{3}L^{2}\hbar c z_{R}\sigma_{\gamma}\sigma_{k}}\int_{k_{\mathrm{min}}}^{k_{\mathrm{max}}}\int_{-\theta_{x,\mathrm{max}}}^{\theta_{x,\mathrm{max}}}\int_{-\theta_{y,\mathrm{max}}}^{\theta_{y,\mathrm{max}}}\int_{y_{\mathrm{min}}}^{y_{\mathrm{max}}}\int_{x_{\mathrm{min}}}^{x_{\mathrm{max}}}\frac{1}{\sqrt{\zeta_{x}\zeta_{y}}\sigma_{\theta_{x}}\sigma_{\theta_{y}}}\frac{\bar{\gamma}}{1+2\gamma E_{L}/m_{e}c^{2}} \\
\times\left\{\frac{1}{4}\left[\frac{4\bar{\gamma}^{2}E_{L}}{E_{\gamma}\left(1+\bar{\gamma}^{2}\theta^{2}\right)}+\frac{E_{\gamma}\left(1+\bar{\gamma}^{2}\theta^{2}\right)}{4\bar{\gamma}^{2}E_{L}}\right]-2\cos^{2}\left(\tau-\phi_{f}\right)\frac{\bar{\gamma}^{2}\theta^{2}}{\left(1+\bar{\gamma}^{2}\theta^{2}\right)^{2}}\right\} \\
\times\exp{\left[-\frac{\left(\theta_{x}-x_{c}/L\right)^{2}}{2\sigma_{\theta_{x}}^{2}}-\frac{\left(\theta_{y}-y_{c}/L\right)^{2}}{2\sigma_{\theta_{y}}^{2}}-\frac{\left(\gamma-\gamma_{0}\right)^{2}}{2\sigma_{\gamma}^{2}}-\frac{\left(k-k_{0}\right)^{2}}{2\sigma_{k}^{2}}\right]}dx_{c}~dy_{c}~d\theta_{y}~d\theta_{x}~dk,
\label{eq:ICARUS_equation}
\end{multline}
where the cross section has been expanded in terms of the $\bar{\gamma}$ parameter with a normalisation factor, $\gamma_{0}$ is the centroid Lorentz factor of the electron bunch, $\sigma_{\gamma} = \sigma_{e}/m_{e}c^{2}$ is the spread of the Lorentz factor of the electron bunch and integral limits have been imposed. 

The integral over the collimator aperture ($dx_{c}$ and $dy_{c}$) can be carried out with the limits $x/y_{\mathrm{min}}$ and $x/y_{\mathrm{max}}$ which vary dependent on the collimator shape (rectangular or circular) and based on the specified collimator dimensions. For the circular collimation case, the relationship $R\geq\sqrt{x_{c}^{2}+y_{c}^{2}}$ must be obeyed with $R$ the radius of the collimator. For example, in the $x$ plane of the collimator $x_{\mathrm{min}} = -R$ and $x_{\mathrm{max}} = R$ i.e the limits are equal to the radius of the collimator, however this means that in the $y$ plane the collimator position integration limits are a function of $x_{c}$: $y_{\mathrm{min}} = -\sqrt{R^{2}-x_{c}^{2}}$ and $y_{\mathrm{max}} = \sqrt{R^{2}-x_{c}^{2}}$. For the case of a rectangular collimator these limits can be treated independently.  

Integrals over the projection of the scattering angles in each plane are carried out using the limits
\begin{align}
\theta_{x,\mathrm{max}} &= \sqrt{\frac{4E_{L}}{E_{\gamma}}-\theta_{y}^{2}}, & \theta_{x,\mathrm{min}} &= -\sqrt{\frac{4E_{L}}{E_{\gamma}}-\theta_{y}^{2}} \nonumber\\ 
\theta_{y,\mathrm{max}} &= \sqrt{\frac{4E_{L}}{E_{\gamma}}}, & \theta_{y,\mathrm{min}} &= -\sqrt{\frac{4E_{L}}{E_{\gamma}}},  
\end{align}
which constrains the angular cone the radiation is produced into to a $\pm 1/\gamma$ cone in two dimensions. As the limits of the integral on $\theta_{x}$ is dependent on  $\theta_{y}$, this constrains the order of integration -- $\theta_{y}$ must be evaluated before $\theta_{x}$. The order of integration is similarly constrained for the aforementioned circular collimator aperture case.

Integration over the wavenumber $k$ of the incident laser photon in Sun et al's model \cite{sun2009characterizations,sun2011theoretical} is from the limits $0$ to $\infty$ to reflect a summation over all possible laser harmonics. However, this is impractical in a real simulation and unneccessary for laser driven sources as the fundamental harmonic is the laser wavelength of interest and other harmonics will have incredibly weak contribution or be excluded completely due to re-circulation in a Fabry-Perot optical cavity. Therefore, the limit for the integration of the wavenumber of the incident laser is set to $k\pm3\sigma_{k}$ representing the 3$\sigma_{k}$ spectral bandwidth tail of the laser pulse, as the laser pulse is modelled using a Gaussian distribution.  

The polarisation term $2\cos^{2}\left(\tau-\phi_{f}\right)$ in (Eq.~\ref{eq:ICARUS_equation}) must be modified as the azimuthal scattering angle $\phi_{f}$ is not explicitly integrated over, instead the azimuthal scattering angle dependence is covered via integration of the projection of the scattering angles ($\theta_{x}$ and $\theta_{y}$) in each plane. Therefore, we replace the azimuthal scattering angle $\phi_{f}$ in (Eq.~\ref{eq:ICARUS_equation}) with $\phi_{f} = \cos^{-1}\left(\theta_{x}/\theta\right)$. The $x$ plane projection of the scattering angle $\theta_{x}$ is selected over the $y$ plane due to order of integration constraints. However, it is trivial to show that when integrated over the full azimuthal scattering angle ($0 \leq \phi_{f} \leq 2\pi$), as is the case in evaluating (Eq.~\ref{eq:ICARUS_equation}), the polarisation term is negligible.

The \textsc{ICARUS} spectrum code is operated as a Mathematica script with pre-input of ICS source parameters (electron bunch and laser pulse parameters) and post-processing which produces plots of spectra from the developed model and calculates the spectral yield i.e collimated flux from the produced spectrum. The spectrum simulation evaluates (Eq.~\ref{eq:ICARUS_equation}) at a series of scattered photon energy points to determine the number of photons produced at scattered photon energy intervals thereby building up a spectrum. The maximum scattered photon energy to sample for the spectrum calculation is calculated for the head-on case with $E_{e}+3\sigma_{e}$ as the electron bunch energy, however this neglects the laser pulse energy spread though since the electron bunch energy has a squared dependence on scattered photon energy ($E_{\gamma}\propto\gamma^{2}$) in comparison to scattered photon energies linear relationship with laser wavelength this is a fair assumption unless the spectral bandwidth of the laser is large. The minimum sampled scattered photon energy is $E_{\gamma,\mathrm{min}} = E_{\gamma,\mathrm{COM}}\left[1-3\left(\frac{\Delta E_{\gamma}}{E_{\gamma}}\right)_{\mathrm{FWHM}}\right]$, the Compton edge energy reduced by a factor of $3\sigma$, with sigma the full-width half-maximum bandwidth of the ICS source being simulated. This minimum energy is generally appropriate for ICS spectra, however when the spectrum is highly dominated by strong collimation $E_{\gamma,\mathrm{min}}$ is much smaller than the scattered photon energy of the low energy tail of the spectrum. The number of sampled points in the simulation is usually set at 100, but is determined due to the computational time and precision requirements of the user -- simulation time typically scales linearly with simulation points.  

For the complex integration involved in evaluating the central equation of \textsc{ICARUS} (Eq.~\ref{eq:ICARUS_equation}), quasi-Monte Carlo (QMC) integration methods are used alongside parallel-processing, where each node iterates an individual scattered photon energy point in the simulation. Typically 100 million QMC points are used to create a precise spectrum, though this simulation parameter can be adjusted with greater precision -- more QMC points -- costing greater simulation time.

To summarise, the model presented here has been adapted from the model by Sun et al \cite{sun2009characterizations,sun2011theoretical} through modification of the polarisation term in order to treat the azimuthal scattering angle dependence properly, revised integral limits for the wavenumber integration to limit this to the fundamental mode within reasonable $3\sigma$ spectral bandwidth tolerances and to correct the algebraic error involving the source-to-detector distance $L$ so the formula obeys the inverse square law. These modifications have allowed the \textsc{ICARUS} code to correctly take into account both circular and linear polarisation within the spectrum, properly account for the effect of the laser spectral bandwidth on the produced radiation (by limiting the calculation to the fundamental harmonic) and for the spectrum code to produce quantitative predictions of the spectral density, with the abandonment of the arbitrary units quoted by Sun et al \cite{sun2009characterizations,sun2011theoretical} for the spectra. This model has been built into a semi-analytical code in Mathematica designed to produce spectra and calculate the collimated flux from a set of ICS source electron bunch and laser pulse parameters. Further work could include extending the model (Eq.~\ref{eq:ICARUS_equation}) for an angular crossing, accounting for non-Gaussian laser pulse and electron bunch distributions and generalising the model from the small angle and far-field collimation approximations it relies upon, though this is beyond the scope of this current work.        

\section{Benchmarking Cases for Characterisation and Optimisation}
\label{sec:benchmarking_cases_characterisation_optimisation}

\textcolor{blue}{\textbf{**THESE PARAMETERS ARE VERY MUCH A WORK IN PROGRESS** \\ **NEED TO BE JUSTIFIED + TALKED THROUGH**} \\ **DIANA-ISH, MAX-III NEQ RING (HYWEL + PETE), ODU ICS LINAC (KIRSTEN)** \\  }

\textcolor{blue}{\textbf{**NEED TO JUSTIFY THE MAX-III PARAMETERS**}\\**NOT NON-EQUILIBRIUM SET**}

A series of three cases have been devised to test both the characterisation and optimisation methods outlined within this chapter. The cases are each designed to imitate three accelerator types that could be used to operate an inverse Compton scattering source including: a high energy ERL driven $\gamma$-ray ICS source case (Case A), a precursor to the DIANA design in Chapter~\ref{DIANA_Inverse_Compton_Source_Design}, a storage ring case based on a $\gamma$-ray ICS source driven by the MAX-III storage ring  \cite{owen2013nonequilibrium} (Case B), and a low energy, high repetition rate linac based on the Old Dominion University x-ray ICS source design \cite{krafft2016laser,deitrick2017inverse,deitrick2018high} (Case C). The electron bunch parameters at the interaction point for each of these cases are shown in Table~\ref{tab:char_opt_electron_bunch_parameters}.

\begin{table}[!h]
\centering
\caption{Electron bunch parameters at the interaction point. Parameters are given for three cases: a state-of-the-art 1~\si{\giga\electronvolt} ERL -- a precursor of the DIANA ERL (Chapter~\ref{DIANA_Inverse_Compton_Source_Design}) -- (Case A), the MAX-III storage ring operated at 700~\si{\mega\electronvolt} \cite{sjostrom2009max,hansson2011imaging,rosborg2012electron} (Case B) and the designed ODU ICS 25~\si{\mega\electronvolt} high repetition rate linac \cite{krafft2016laser,deitrick2017inverse,deitrick2018high} (Case C).}
\label{tab:char_opt_electron_bunch_parameters}
\begin{tabular}{lcccc}
\hline\hline
Parameter & Case A & Case B & Case C & Unit \\
\hline
Kinetic Energy, $E_{e}$ & 1000 & 700 & 25 & \si{\mega\electronvolt} \\
Repetition Rate, $f$ & 100 & 83.33 & 100 & \si{\mega\hertz} \\
Bunch Charge, $Q$ & 100 & 3000 & 10 & \si{\pico\coulomb} \\
Normalised Transverse Emittance, $\epsilon_{n,x}/\epsilon_{n,y}$ & 0.50/0.50 & 18.78/0.233 & 0.10/0.10 & \si{\milli\meter}-\si{\milli\radian} \\
Bunch Length, $\sigma_{e,z}$ & 1.00 & 27.9 & 0.38 & \si{\milli\meter} \\
Relative Energy Spread, $\Delta E_{e}/E_{e}$ & $10^{-4}$ & $6.07\times 10^{-4}$ & $3.00\times 10^{-4}$ & \\
\hline\hline
\end{tabular}
\label{tab:char_opt_electron_bunch_parameters}
\end{table}

\textcolor{blue}{**JUSTIFY THE CHOOSING OF THESE ACCELERATORS AS CASES -- NEEDS SOME WORK IMO**\\}
The three electron bunch cases in Table~\ref{tab:char_opt_electron_bunch_parameters} have electron bunch energies chosen to reflect the typical electron bunch energy regimes of x-ray ($E_{e} =$10's~\si{\mega\electronvolt}) and $\gamma$-ray ($E_{e} =$100's~\si{\mega\electronvolt}) production most designed and operating ICS sources are focused upon. Within the three electron bunch cases, each of the main accelerator driver options for ICS sources are represented: an ERL, storage ring and linac, therefore this should provide a fair overview of the applicability of the developed methods to a wide range of ICS source designs. The three accelerator cases in Table~\ref{tab:char_opt_electron_bunch_parameters} provide a large range in electron bunch energy (25--1000~\si{\mega\electronvolt}) as well as a large variation in bunch charge (10~\si{\pico\coulomb}--3~\si{\nano\coulomb}), tranverse normalised emittance (0.1--18.78~\si{\milli\meter}-\si{\milli\radian}) and bunch length (0.38--26.7~\si{\milli\meter}) which should be suitable for evaluating the optimisation and characterisation methods and determining their efficacy in modelling a range of ICS sources. Each of these sources has a high $\sim100$~\si{\mega\hertz} repetition rate which means they are suitable for design of high flux ICS sources using Fabry-Perot cavities which these codes are designed for but not limited to. 

Case A electron bunch parameters are typical of a world leading 1~\si{\giga\electronvolt} 3-turn energy recovery linac, which are precursors of the conceptual DIANA ERL and ICS source that is presented in Chapter~\ref{DIANA_Inverse_Compton_Source_Design}. The DIANA ERL design is based upon an ERL driven FEL design by ASML \cite{akkermans2017compact}, the PERLE energy recovery linac \cite{angal2018perle} and the ER@CEBAF ERL project \cite{meot2016er,bogacz2016er} and designed to operate within the parameter space these ERL could demonstrate that would be optimal for both $\gamma$-ray ICS source and EUV FEL applications. The justification for the case B electron bunch parameters is fully explained in Chapter~\ref{DIANA_Inverse_Compton_Source_Design} and consequently not repeated here.       

The electron beam parameters of case B are based upon the electron bunch parameters of the MAX-III storage ring synchrotron light source \cite{sjostrom2009max,hansson2011imaging,rosborg2012electron}. Whilst the existing accelerator does not have an ICS interaction point, a set of focusing optics and a Fabry-Perot cavity could be introduced into one of the straight sections in the 36~\si{\metre} circumference. Operation of MAX-III as an ICS source has been suggested by Owen et al \cite{owen2013nonequilibrium}; many other synchrotron light sources have been used as an ICS source such as HI$\gamma$S at the Duke University storage ring \cite{weller2009research}, NewSUBARU \cite{utsunomiya2015gamma} and a similar design to a MAX-III ICS source has been proposed by Pan et al \cite{pan2019design}. Whilst a range of configurations are possible for MAX-III \cite{sjostrom2009max}, including variations in operational mode such as non-equilibrium operation \cite{owen2012modular}, the parameters for case B are based on Sj\"{o}strom et al \cite{sjostrom2009max} using emittance measurements by Hansson et al \cite{hansson2011imaging}. Notably the repetition rate is lower for the case B parameters than the 100~\si{\mega\hertz} repetition rate of case A and C due to the limitation of the MAX-III repitition rate \cite{sjostrom2009max,rosborg2012electron}. At a current of 250~\si{\milli\amperes}, with a 36~\si{\meter} circumference and repetition rate of 83.33~\si{\mega\hertz} \cite{sjostrom2009max,rosborg2012electron} there must be a total of 10 3~\si{\pico\coulomb} bunches.

Case C is based upon the design of the ODU ICS source \cite{krafft2016laser,deitrick2017inverse,deitrick2018high} which is designed as a compact x-ray ICS source. The ODU ICS source is a high repetition rate ($f = 100$~\si{\mega\hertz}) linac, therefore is comparable to the ERL and storage ring ICS approaches included here and could utilise a high average power Fabry-Perot cavity for the production of x-rays. The design study for this linac is completed with start-to-end simulations and therefore beam parameters are comprehensively presented \cite{deitrick2017inverse,deitrick2018high} which are used in this case. Small emittance and energy spread parameters of the ODU linac are attractive for development of a narrowband ICS source hence this designs inclusion within this study.  

The laser parameters for the test case ICS sources, based on the electron bunch parameters in Table~\ref{tab:char_opt_electron_bunch_parameters}, are kept constant, with the exception of an adjusted repetition rate for the MAX-III case B parameters, so the effect of the electron bunch on the ICS spectrum and optimisation is observable with the invariant laser parameters presented in Table~\ref{tab:char_opt_laser_pulse_parameters}. The laser parameters are based upon an Nd:YAG laser ($\lambda = 1064$~\si{\nano\meter}) re-circulated in a 4-mirror Fabry-Perot optical cavity based on the cERL ICS demonstration at KEK \cite{akagi2016narrow}. 

\begin{table}[!h]
\centering
\caption{Laser pulse parameters at the interaction point. Each accelerator electron bunch case in Table~\ref{tab:char_opt_electron_bunch_parameters} is assumed to interact with identical laser pulse parameters at the IP.}
\begin{threeparttable}
\begin{tabular}{lcc}
\hline\hline
Parameter & Quantity & Unit \\
\hline
Wavelength, $\lambda_\textrm{laser}$ & 1064 & nm\\
Photon energy, $E_\textrm{laser}$ & 1.17 & eV\\
Pulse energy  & 0.1 & \si{\milli\joule}\\
Number of photons, $N_{\textrm{laser}}$ & $5.34\times 10^{14}$\\ 
Repetition rate, $f$ & 100 (83.33)\tnote{*} & MHz\\
Spot size at the IP, $\sigma_{L}$ & 30 & \si{\micro\meter}\\
Crossing angle, $\phi$ & 5 & deg \\
Pulse length  & 10 & ps\\
Spectral Bandwidth, $\Delta E_\textrm{laser}/E_\textrm{laser}$ & 4.66$\times 10^{-4}$ &   \\
 % 0.5nm rms error on 1064nm
\hline\hline
\end{tabular}
\begin{tablenotes}
\item[*]{Adjusted to compensate for the lower case B (MAX-III \cite{sjostrom2009max,rosborg2012electron}) repetition rate.}
\end{tablenotes}
\end{threeparttable}
\label{tab:char_opt_laser_pulse_parameters}
\end{table}

\textcolor{blue}{**JUSTIFY THE LASER PARAMETERS**\\}
The optical cavity envisioned to deliver these laser parameters has an average stored power of 10~\si{\kilo\watt} (Case B: 8.33~\si{\kilo\watt}), well below demonstrations at MuCLS \cite{eggl2016munich} and the state-of-the-art 670~\si{\kilo\watt} stored average power optical cavity \cite{carstens2014megawatt}. At a repetition rate of 100~\si{\mega\hertz}, and the case B reduction to 83.33~\si{\mega\hertz} repetition rate, the cavity path length is $\sim3$~\si{\meter} which is tolerable for both misalignment errors and mirror heating considerations with a single stored 0.1~\si{\milli\joule} laser pulse. Inclusion of a Fabry-Perot cavity in the case A ERL is as described for the DIANA ERL ICS design (Chapter~\ref{DIANA_Inverse_Compton_Source_Design}), a Fabry-Perot cavity can be incorporated within a straight -- as is the case for the DIANA ERL -- in a design like the MAX-III storage ring case B is based on though the rammifications for the optics are beyond the scope of this work, and the laser system envisioned in the ODU ICS could be replaced by this Fabry-Perot cavity as the IP is designed with sufficient space from the final focus triplet \cite{deitrick2018high}.    

\section{Benchmarking of Characterisation Methods}
\label{sec:benchmarking_of_the_ICARUS_spectrum_code}

\textcolor{blue}{ **Add on the ICARUS data for these** }

The analytical collimated flux derivation (Eq.~\ref{eq:collimated_flux}) in Section~\ref{sec:analytical_collimated_flux} has been compared against both the developed \textsc{ICARUS} code (Section~\ref{sec:development_of_the_ICARUS_spectrum_code}) and an analytical collimated flux method by Curatolo et al \cite{curatolo2017analytical}, using the test case parameters (Tables~\ref{tab:char_opt_electron_bunch_parameters} and \ref{tab:char_opt_laser_pulse_parameters}) as described in Section~\ref{sec:benchmarking_cases_characterisation_optimisation}. All methods should be capable of calculating the flux within a particular collimation angle; agreement of the derived analytical collimated flux calculation (Eq.~\ref{eq:collimated_flux}) is expected to be within $\sim10$\% of the full spectral yield calculation from the \textsc{ICARUS} spectrum code as the only differences between these models are a neglect of the energy spread of the electron bunch, spectral bandwidth and point source approximation. 

The analytical calculation of collimated flux by Curatolo et al \cite{curatolo2017analytical} in 'natural units' is given by  
\begin{equation}
\mathcal{F}_{\mathrm{col}} = 6.25\times 10^{8}\frac{E_{\mathrm{pulse}}\left(\mathrm{\si{\joule}}\right)Q\left(\si{\pico\coulomb}\right)f\left(\si{\hertz}\right)}{E_{L}\left(\si{\electronvolt}\right)\left[\sigma_{x}^{2}\left(\si{\micro\meter}\right)+\sigma_{L}^{2}\left(\si{\micro\meter}\right)\right]}\times\frac{\left(1+\sqrt[3]{X}\Psi^{2}/3\right)\Psi^{2}}{\left[1+\left(1+X/2\right)\Psi^{2}\right]\left(1+\Psi^{2}\right)},
\label{eq:curatolo_collimated_flux}
\end{equation}
where all symbols are consistent with the exception of $\sigma_{x}$, which in the work of Curatolo et al is the \textit{rms} spot size of the electron bunch at the IP and $\Psi = \gamma\theta_{\mathrm{col}}$, the acceptance angle. The collimated flux calculation by Curatolo et al \cite{curatolo2017analytical} apparently uses the Berestetskii, Pitaevskii and Lifshitz \cite{berestetskii1982quantum} differential cross section as is used in the derivation in Section~\ref{sec:analytical_collimated_flux} however, an explicit derivation is not shown or referenced. Upon inspection of (Eq.~\ref{eq:curatolo_collimated_flux}), it is evident that this is only valid for a head-on ($\phi=0$) interaction, for round electron spot sizes, where the $x$ and $y$ plane spot sizes are identical, doesn't take into account the hourglass effect \cite{furman1991hourglass,miyahara2008luminosity} and it appears the cross section is assumed to be the Thomson cross section, not the recoil corrected cross section unlike the calculation in (Eq.~\ref{eq:collimated_flux}).   

In Fig.~\ref{fig:curatolo_collimated_flux_comparison}, the derived analytical calculation (Eq.~\ref{eq:collimated_flux}), and (Eq.~\ref{eq:curatolo_collimated_flux}) with neglected hourglass effect and a head-on interaction ($\phi = 0$), is compared with the calculation by Curatolo et al \cite{curatolo2017analytical} (Eq.~\ref{eq:curatolo_collimated_flux}) and the spectral yield (collimated flux) of the \textsc{ICARUS} spectrum code. The comparison is made in Fig.~\ref{fig:curatolo_collimated_flux_comparison} through calculation of the collimated flux against the acceptance angle $\Psi = \gamma\theta_{\mathrm{col}}$ for each of the cases in Table~\ref{tab:char_opt_electron_bunch_parameters} with the transverse profile matching condition ($\sigma_{e} = \sigma_{L}$, see Section~\ref{sec:transverse_profile_matching}) applied -- where the laser pulse \textit{rms} spot size and electron bunch \textit{rms} spot size are identical ($\sigma_{e} = \sigma_{L} = 30$~\si{\micro\meter}), which in this case is set by the laser pulse \textit{rms} spot size in Table~\ref{tab:char_opt_laser_pulse_parameters}.    

\begin{figure}[!h]
\centering
\includegraphics[width=\textwidth]{Figures/Optimisation_and_Characterisation_of_Inverse_Compton_Scattering_Sources/Opt_Char_Fcol_Curatolo_Comp_FINAL.pdf}
\caption{Comparison of the derived analytical caluclation in this work (Eq.~\ref{eq:collimated_flux}) (blue) with the Curatolo et al \cite{curatolo2017analytical} calculation (Eq.~\ref{eq:curatolo_collimated_flux}) (red) within an acceptance angle $0 \geq \Psi \geq 1$ (a $1/\gamma$ cone). Electron bunch and laser pulse spot sizes are matched ($\sigma_{e}=\sigma_{L}=30$~\si{\micro\meter}). Left: (Eq.~\ref{eq:collimated_flux}) includes hourglass effect ($R_{ACHG}\neq 1$). Right: (Eq.~\ref{eq:collimated_flux}) neglects the hourglass effect ($R_{ACHG} = 1$). Top: Case A. Middle: Case B. Bottom: Case C. \textcolor{blue}{**ADD THE ICARUS RUNS TO THESE PLOTS, LIKE BALSA HAS WITH THE BW COMPARISON**}}
\label{fig:curatolo_collimated_flux_comparison}
\end{figure}

With reference to Fig.~\ref{fig:curatolo_collimated_flux_comparison}, it is clear that the two analytical models disagree substantially, with a systematic reduction in collimated flux observed for the calculation by Curatolo et al. \cite{curatolo2017analytical}, for all cases except case B with the hourglass effect. The reason for this discrepancy is because the hourglass reduction (Eq.~\ref{eq:miyahara_combined_reduction}) is large ($R_{ACHG} = 0.274$; a 72.\% luminosity reduction) for case B due to the long 93~\si{\pico\second} electron bunch duration. With the hourglass effect removed, this discrepancy seems to have the same functional form -- the discrepancy increases non-linearly as a function of acceptance angle.

A scaling factor is introduced 
\begin{equation}
\mathrm{SF} = \frac{\mathcal{F}_{\mathrm{col}}\left[\mathrm{This~ Work}\right]}{\mathcal{F}_{\mathrm{col}}\left[\mathrm{Curatolo~et~ al}\right]},
\label{eq:curatolo_scaling_factor}
\end{equation}
between this work (Eq.~\ref{eq:collimated_flux}) and the Curatolo calculation (Eq.~\ref{eq:curatolo_collimated_flux}) in order to show this relationship more explicitly. The scaling factor is plotted against acceptance angle in Fig.~\ref{fig:curatolo_scaling_factor_comparison}. At small acceptance angles, as shown by Fig.~\ref{fig:curatolot_scaling_factor_comparison}, there appears to be a constant offset then at larger acceptance angles ($\Psi > 0.4$) the difference between calculations and therefore the scale factor increases. The behaviour as a function of acceptance angle suggests a small angle approximation has been used in the derivation of Curatolo et al's \cite{curatolo2017analytical} calculation. When the hourglass effect is neglected in Fig.~\ref{fig:curatolo_scaling_factor_comparison}, the scaling factor increase with acceptance angle becomes more apparent and it is evident that this relationship is similar for each case which would be expected of a small angle approximation. However, the constant offset can't be explained by the hourglass effect introduced in (Eq.~\ref{eq:collimated_flux}), as this is still evident after the hourglass effect is neglected. Therefore, the appearance of a constant offset between the two analytical models but a difference in constant offset between cases could only be explained via variation of electron bunch energy, a systematic error in the accounting of the collimation angle or emittance/spot size effects in each calculation, as the laser parameters are invariant between the cases. The origin of this discrepancy remains unknown and can not be understood because of the lack of a derivation of Curatolo et al's calculation (Eq.~\ref{eq:curatolo_collimated_flux}) \cite{curatolo2017analytical}. 

\textcolor{blue}{**NEED TO ADD ICARUS vs ANALYTICAL DISCUSSION HERE**}

\begin{figure}[!h]
\centering
\includegraphics[width=\textwidth]{Figures/Optimisation_and_Characterisation_of_Inverse_Compton_Scattering_Sources/Opt_Char_Fcol_Curatolo_SF_FINAL.pdf}
\caption{Scaling factor between the analytical collimated flux equation developed in this work (Eq.~\ref{eq:collimated_flux}) and Curatolo et al's \cite{curatolo2017analytical} calculation (Eq.~\ref{eq:curatolo_collimated_flux}) against acceptance angle for case A (red), case B (blue) and case C (orange) presented in Table~\ref{tab:char_opt_electron_bunch_parameters}. Left: (Eq.~\ref{eq:collimated_flux}) includes hourglass effect ($R_{ACHG}\neq 1$). Right: (Eq.~\ref{eq:collimated_flux}) neglects the hourglass effect ($R_{ACHG} = 1$).}
\label{fig:curatolo_scaling_factor_comparison}
\end{figure}

In addition, as shown in Section~\ref{sec:bandwidth}, the relationships between the two analytical collimated flux calculations resembles the relationships between the two analytical bandwidth models in Fig.~1 of Ranjan et al \cite{ranjan2018simulation} which shows a similar underestimation by Curatolo et al \cite{curatolo2017analytical}, as observed in Fig.~\ref{fig:curatolo_collimated_flux_comparison}.

To benchmark the \textsc{ICARUS} spectrum code, the \textsc{ICCS3D} code \cite{krafft2016laser,ranjan2018simulation} was selected as \textsc{ICCS3D} also aims to predict spectra of ICS sources in the linear regime with a similar semi-analytical approach. \textsc{ICCS3D} provides a good benchmarking standard because  \textsc{ICCS3D} code has also previously been benchmarked against the 1D model by Sun et al \cite{sun2009energy}, see Krafft et al \cite{krafft2016laser} Fig.~2--4, and the \textsc{CAIN} Monte Carlo code, see Ranjan et al\cite{ranjan2018simulation} Fig.~7. Through benchmarking of \textsc{ICARUS} with \textsc{ICCS3D}, improvements to \textsc{ICCS3D} were made such as introducing a new integration method to handle laser pulse durations on the order of 10's~\si{\pico\seconds} and the application of non-arbitrary units in the simulation.

The \textsc{ICCS3D} spectrum code, a generalization of the \textsc{ICCS} code \cite{krafft2016laser,ranjan2018simulation}, computes radiation produced in ICS within the linear Compton regime (when $a_{0}\ll 1$, and electron recoil is properly accounted for). In \textsc{ICCS3D}, a 3D laser pulse model replaces the 1D plane wave model used in \textsc{ICCS}. This modification is implemented in a manner described in Terzi\'c et al \cite{terzic2019improving}; instead of all electrons experiencing the same laser field strength $a_{0}$, as they do for a 1D plane wave, their effective laser field strength is dependent on the electron's distance from the laser's center at the moment of scattering. To calculate anticipated spectral output, in addition to the laser parameters, \textsc{ICCS3D} can use either the parameters of the electron beam or an arbitrary electron distribution -- which could be tracked through the accelerator driver -- allowing start-to-end simulation of ICS sources. 

\textcolor{blue}{**CASE PLOTS OF SPECTRA AGAINST ICCS3D SPECTRA** \\ **NEED CONFIRMATION OF THE CASES** \\ **NEED TO MAKE SPECTRA PLOTS** \\ **NEED TO GET THE ICCS3D PLOTS** \\ **TALK ABOUT THE PLOTS**}

\section{Motivation for Narrowband Optimisation of ICS Sources}
\label{sec:motivation_optimisation}

\textcolor{blue}{\textbf{**CONSIDER SPLITTING THIS AND ADDING A SECTION ON OBJECTIVE FUNCTIONS AND VARIABLES**}}

Currently, many ICS sources \cite{deitrick2017inverse,deitrick2018high} \textcolor{blue}{**NEED MORE**} are designed with regard to producing the maximum uncollimated flux from the ICS interaction. However, within design of an inverse Compton scattering source for light source experimentation there are two objectives: to produce a large quantity of photons and to minimise the energy spread i.e bandwidth of the scattered radiation towards a monochromatic source. The former, a high flux of photons, is desirable because a high flux speeds up data acquisition times and can improve the signal-to-noise ratio of measurements and the later is advantageous due to the ability to target only a certain process, for example a specific resonance in $^{235}\mathrm{U}$ in a nuclear resonance fluorescence investigation. Users typically require a compromise on bandwidth and flux to have enough precision to investigate a specific phenomena whilst needing to make measurements on a reasonable timescale, with adequate statistics. Therefore, within the following optimisations we aim to maximise the collimated flux (Eq.~\ref{eq:collimated_flux}) whilst minimising, or limiting to some user specified value, the \textit{rms} bandwidth (Eq.~\ref{eq:RMS_bandwidth}) of the source.

In order to maximise the collimated flux within a user determined bandwidth the transverse dynamics of the electron bunch and the collimation are modified. Variables include the $\beta$-functions of the electron bunch at the IP and the collimation angle; justification for these choices is provided in Section~\ref{sec:objective_functions_and_variables}. Therefore, this problem becomes a multidimensional multiobjective optimisation problem with up to 3 variables and 2 objective functions. Local optimisation techniques may be insufficient because the parameter space of this optimisation is non-linear -- the objective functions do not vary linearly with the variables -- and the complexity of the parameter space is unknown, consequently both global and local optimisation techniques are trialed.

Transverse electron bunch dynamics are selected for optimisation as preliminary scaling studies showed that this would be the most effective variable set to improve the collimated flux within an \textit{rms} bandwidth, whilst optimising with the transverse dynamics of the laser pulse is more complex as this impacts optical re-circulation cavity design, for which a full design was beyond the scope of this study. Longitudinal dynamics were also considered as a potential route to optimisation of the bandwidth and collimated flux of an ICS source however, due to the interplay of an RF system with the electron bunch length, optimisation using these dynamics would require a more complete accelerator design than transverse dynamics, with a lesser collimated flux advantage predicted due to the weak relation between electron bunch length and collimated flux. Because of the added complexity transverse laser pulse and longitudinal electron bunch optimisations are considered possible future work but excluded from this work.   

Within the optimisation work several optimisation methods: a round beam optimisation, a non-round beam simplex optimisation and a non-round beam genetic algorithm method are developed and tested to solve the multi-objective optimisation problem. Round beam optimisations simplify the transverse dynamics to be identical in each plane ($x$ and $y$), hence a 1D approach, whereas non-round beam optimisations are a full 2D approach that treats each plane individually. The 1D round beam optimisation in Section~\ref{sec:RB_optimisation} uses a brute force optimisation approach, calculating each possible solution then sorting for the best solution. More sophisticated algorithms are required for 2D non-round beams as the parameter space is significantly expanded and unbounded.  The 2D non-round beam optimisations use a simplex/Nelder-Mead method, based on the Nelder-Mead NMaximise routine in \textsc{Mathematica} \cite{wolfram2021nmaximize}, and the upgraded strength Pareto evolutionary algorithm (\textsc{SPEA2}) genetic algorithm \cite{zitzler2001spea2} -- a genetic algorithm (GA) -- with the \textsc{PISA} platform \cite{bleuler2003pisa}, where a series of \textsc{Python} scripts have been wrote to interface with this generalised multi-objective optimisation code.    

In the second half of this chapter the objective functions and variables of the optimisations are justified, a default ICS source configuration -- transverse profile matching -- applied to maximise the flux of many ICS sources is explained, then a series of optimisations such as the 1D round-beam optimisation, 2D non-round beam simplex optimisation and 2D non-round beam genetic algorithm optimisation are developed, which are finally evaluated in Section~\ref{sec:evaluation_of_optimisation_methods}. The electron bunch cases in Table~\ref{tab:char_opt_electron_bunch_parameters} with the laser parameters in Table~\ref{tab:char_opt_laser_pulse_parameters},  as previously used for the characterisation studies, are applied to evaluate the optimisation methods. The optimisation methods are then applied, in various forms, throughout the ICS source and experiment designs in Chapters~\ref{CBETA_Inverse_Compton_Scattering_Source_Design}, \ref{DIANA_Inverse_Compton_Source_Design}, \ref{FEBE_Inverse_Compton_Scattering_Experiment}    

\section{Objective Functions and Variables}
\label{sec:objective_functions_and_variables}

\textcolor{blue}{**JUSTIFICATION OF THE OBJECTIVE FUNCTIONS AND VARIABLES**}

As mentioned in Section~\ref{sec:motivation_optimisation}, we aim to maximise the collimated flux within a user selected bandwidth. The two objective functions required for optimisation are the collimated flux and bandwidth, we select the \textit{rms} bandwidth (Eq.~\ref{eq:RMS_bandwidth}) but extention to the \textit{FWHM} bandwidth (Eq.~\ref{eq:FWHM_bandwidth}) is trivial. In an ICS source, the two objective functions compete as minimising the two typically dominant terms of the \texit{rms} bandwidth (Eq.~\ref{eq:RMS_bandwidth}), the emittance/divergence term (Eq.~\ref{eq:emittance_term}) and the collimation term (Eq.~\ref{eq:collimation_term}), reduces the collimated flux. Therefore, a trade-off between the competing objectives needs to be developed; maximisation of the collimated flux within a user selected \textit{rms} bandwidth. 

Optimisation of the ICS interaction allows for understanding of the best ICS source configuration for a particular experiment and for the mapping of the parameter space of an ICS source. Through use of tuning curves, where a Pareto front is generated in collimated flux--\textit{rms} bandwidth space, the possible configurations of an ICS source can be understood. Whereas in a single bandwidth point optimisation, where the $\textit{rms}$ bandwidth objective is replaced by a penalty function
\begin{equation}
\left|\left(\frac{\Delta E_{\gamma}}{E_{\gamma}}\right)_{\mathrm{tar}}-\left(\frac{\Delta E_{\gamma}}{E_{\gamma}}\right)_{\mathrm{ach}}\right|,
\label{eq:penalty_function}
\end{equation}
where $\left(\Delta E_{\gamma}/E_{\gamma}\right)_{\mathrm{tar}}$ is the user targeted bandwidth and $\left(\Delta E_{\gamma}/E_{\gamma}\right)_{\mathrm{ach}}$ is the bandwidth achieved by the optimisation, allowing for determination of the best electron bunch and collimation settings for a particular experiment. Therefore, methods are developed to perform both tuning curve optimisations and single point optimisations.

Through inspection of the emittance (Eq.~\ref{eq:emittance_term}) and collimation (Eq.~\ref{eq:collimation_term}) terms of the bandwidth it is evident that optimisation is possible via control of the transverse dynamics at the IP (transverse emittances and $\beta$-functions at the IP) and the collimator specification (collimation angle). Varying the $\beta$-functions at the IP is advantageous over varying the transverse emittance as the $\beta$-functions can be varied through adjustment of the final focus system whereas the transverse emittance is dependent on the electron photoinjector and the collective effects experienced by the bunch throughout the accelerator, from generation of the bunch to interaction. Collimation of the produced radiation is conducted externally to the accelerator, therefore collimation angle is an easy parameter to adjust with a selection of collimators, a variable aperture collimator or by adjusting the source-to-collimator distance. The chosen variable parameters can be tuned for any accelerator type and therefore this work is generalised to any accelerator driver of an ICS source, not just an ERL.

The $\beta$-function at the interaction point must be greater than zero, and due to the limitations of final focuses imposed in ICS sources the $\beta$-function is more realistically lower bounded to the \si{\milli\meter}-scale ($\beta_{x/y}^{*} > 1$~\si{\milli\meter}). \textcolor{blue}{**Reference on limits of final focus? ILC? EIC?**} The upper bounding of the $\beta^{*}$-functions is optimisation case specific; an upper limit can be derived in the round beam case (see Section~\ref{}) but an arbitrarily defined upper bound is required in the 2D non-round beam case. Throughout all optimisation cases the collimation angle can be bounded as the collimation angle must be larger than zero ($\theta_{\mathrm{col}}$) -- or the collimator becomes an attenuator -- and can be upper bounded through the assumption that the collimation term is dominant i.e the \textit{rms} bandwidth becomes
\begin{equation}
\left(\frac{\Delta E_{\gamma}}{E_{\gamma}}\right)_{\mathrm{rms}} \approx \left(\frac{\sigma_{\theta}}{E_{\theta}}\right),    
\label{eq:collimation_dominant}
\end{equation}
which, through expansion of the collimation term (Eq.~\ref{eq:collimation_term}) can be recast as an approximate upper bound $\theta_{\mathrm{col},\mathrm{max}}$ on the collimation angle 
\begin{equation}
\theta_{\mathrm{col},\mathrm{max}} = \frac{1}{\gamma}\sqrt{\frac{2\sqrt{3}\left(\Delta E_{\gamma}/E_{\gamma}\right)_{\mathrm{rms}}\left[1+X\right]}{1-\sqrt{3}\left(\Delta E_{\gamma}/E_{\gamma}\right)_{\mathrm{rms}}}}
\label{eq:collimation_angle_upper_bound}    
\end{equation}
where all terms have previously been defined and $\theta_{\mathrm{col}}<\theta_{\mathrm{col},\mathrm{max}}$.

\section{Transverse Profile Matching}
\label{sec:transverse_profile_matching}

In the literature \cite{akagi2016narrow,deitrick2018high,jacquet2015radiation} \textcolor{blue}{add more examples, BriXS?}, many inverse Compton scattering sources have attempted to maximise flux output via matching the \textit{rms} spot size of the transverse profile of the laser pulse to that of the electron bunch ($\sigma_{L}\approx\sigma_{\mathrm{electron}}$). Here, we term this the transverse profile matching scheme. The transverse profile matching scheme ignores the full interaction dynamics at the IP in favour of a simplistic solution. 

Once the spot sizes of the electron bunch are matched the collimation angle is the only free parameter in order to control the bandwidth of the ICS source. However, the emittance term of the bandwidth (Eq.~\ref{eq:emittance_term}) is the dominant term, unless emittance is small ($\epsilon_{n} < 1$~\si{\milli\meter}-\si{\milli\radian}) and therefore sets the bandwidth. For example, using case B in Table~\ref{tab:char_opt_electron_bunch_parameters}, the emittance term for transverse profile matching exceeds the collimation term (Eq.~\ref{eq:collimation_term}) up until $\theta_{\mathrm{col}} = 4.25$~\si{\milli\rad}. Therefore, only having a single free parameter means achieving narrow bandwidth without small emittance is not possible. Transverse profile matching also doesn't account for cases, such as case A (Table~\ref{tab:char_opt_electron_bunch_parameters}), with small emittance where the spot size at the IP is fairly large and higher flux may be attained through reducing the electron bunch spot size at the IP. 

The intensity of the laser and electron bunch are often non-uniform transversely within the bunch or pulse (for example in a Gaussian laser pulse), and instead intensity peaks at the centroid. A laser pulse used in inverse Compton scattering is typically more intense by orders of magnitude than the electron bunch ($N_{L} \gg N_{e}$), for example a 1~\si{\nano\coulomb} bunch contains $N_{e} = 6.25\times 10^{9}$ electrons in comparison to a paltry 1~\si{\micro\joule} Nd:YAG ($\lambda = 1064$~\si{\nano\meter}) laser pulse which contains $N_{L} = 5.35\times 10^{12}$ photons. Therefore, to maximise the probability of electron--photon interaction it is favourable to obey the condition $\sigma_{L} > \sigma_{\mathrm{electron}}$.

To first order, the transverse profile matching scheme is a decent approximation for small crossing angles, laser pulse profiles chosen to avoid the worst diffraction effects and near-round transverse profiles ($\sigma_{x,\mathrm{electron}}\sim\sigma_{y,\mathrm{electron}}$); approximate to electron bunches delivered by an ERL or linac. Within experimental tolerances transverse profile matching may be the most attractive scenario, however for ICS light source operation, high flux narrow-bandwidth operation is necessary and optimisation of transverse interaction point parameters can improve this. 

\section{1D Round Beam Optimisation}
\label{sec:RB_optimisation}

The bandwidth of an ICS light source is tuneable and can be selected on the basis of user requirements. Here we develop a brute-force global optimisation method to maximise flux within a selected \textit{rms} bandwidth for the simplified case of an electron beam with a round transverse profile where we assume the normalised emittance is identical in both planes ($\epsilon_{nx} = \epsilon_{ny} = \epsilon_{n}$) and therefore the $\beta$-function at the IP is tuned to the same value in each plane ($\beta_{x}^{*} = \beta_{y}^{*} = \beta^{*}$), this is named the round beam (RB) approximation. Bandwidth tuning is therefore possible via two variables in the 1D case: selecting $\beta^{*}$ at the IP and by setting the collimation angle $\theta_{\mathrm{col}}$. The 1D model is a simplification of the interaction dynamics from the 2D model, with three variables, that is designed to show even simple optimisation can yield improvement in collimated flux.

Within this optimisation derivation, the \textit{rms} bandwidth is given by (Eq.~\ref{eq:RMS_bandwidth}) with the emittance term (Eq.~\ref{eq:emittance_term}) modified for the transversely round bunch case
\begin{equation}
\frac{\sigma_{\epsilon}}{E_{\epsilon}} = \frac{2\gamma\epsilon_{n}}{\left(1+X\right)\beta^{*}},
\label{eq:emittance_term_round_beam}    
\end{equation}
where $X$ is the recoil parameter (Eq.~\ref{eq:X_geometry}), $\epsilon_{n}$ is the transverse \textit{rms} normalised emittance of the electron bunch and $\beta^{*}$ is the $\beta$-function at the interaction point. Typically the dominant terms that define the bandwidth of an inverse Compton source Eq.~(\ref{eq:RMS_bandwidth}) are the collimation term Eq.~(\ref{eq:collimation_term}) and the emittance term Eq.~(\ref{eq:emittance_term_round_beam}). Therefore, optimisation of bandwidth and collimated flux operates as minimisation of the collimation and emittance terms whilst they are traded-off against each other to create the largest collimated flux.

The free parameter of the collimation term is the collimation angle $\theta_{\mathrm{col}}$, which can be adjusted either by changing the collimator aperture or changing its distance from the IP through switchable, fixed-aperture collimators or a variable collimator system as is proposed for the ELI-NP $\gamma$-ray ICS source \cite{paterno2017collimation}. The emittance term is dependent both on the normalised transverse emittance $\epsilon_{n}$ and on $\beta^{*}$. It is more convenient to change the $\beta$-function at the IP with focusing rather than by varying the emittance, since the latter is dependent on the injector and collective effects prior to the IP. 

By using a larger $\beta^{*}$ and a small collimator aperture, it is possible to reduce the contribution of the collimation and emittance terms so that they are negligible; thus the electron bunch (Eq.~\ref{eq:beam_energy_spread_term}) and laser pulse energy spread terms (Eq.~\ref{eq:laser_energy_spread_term}) become dominant for accelerators with a sufficiently small emittance. Taking the limit of a small collimation angle ($\theta_{\mathrm{col}}\rightarrow 0$), and assuming the $\beta$-function at the IP can be made very large ($\beta^{*}\rightarrow 0$) this effectively places a lower limit on the bandwidth of an ICS source; it is limited by the energy spread of the electron beam $\Delta E_{e}/E_{e}$ and laser pulse $\Delta E_{\mathrm{laser}}/E_{\mathrm{laser}}$ as 
\begin{equation}
\left(\frac{\Delta E_{\gamma}}{E_{\gamma}}\right)_{\mathrm{min}} \approx \sqrt{\left[\left(\frac{2+X}{1+X}\right)\frac{\Delta E_{e}}{E_{e}}\right]^{2} + \left[\left(\frac{1}{1+X}\right)\frac{\Delta E_{L}}{E_{L}}\right]^{2}}.
\label{eq:bandwidth_limitation_minimum}
\end{equation}

Consequently, any bandwidth above the theoretical limit (Eq.~\ref{eq:bandwidth_limitation_minimum}) can theoretically be achieved by an ICS source by tuning of the collimation angle and $\beta^{*}$ so that a desired bandwidth, $\Delta E_{\gamma}/E_{\gamma}$, is achieved. Therefore, (Eq.~\ref{eq:bandwidth_limitation_minimum}) provides our lower band. Since the collimation and emittance terms are typically dominant, all other terms can be excluded and the solutions are approximately bounded by
\begin{equation}
\frac{\Delta E_{\gamma}}{E_{\gamma}} > \sqrt{\left(\frac{ \sigma_{\theta}}{E_{\theta}}\right)^{2}+\left(\frac{\sigma_{\epsilon}}{E_{\epsilon}}\right)^{2}}.
\label{eq:bandwidth_limitation_maximum_approximation}
\end{equation}
Making no approximations we can then re-cast the limit in (Eq.~\ref{eq:bandwidth_limitation_maximum_approximation}) in terms of $\beta^{*}$ through a rearrangement of (Eq.~\ref{eq:RMS_bandwidth}) with the emittance term in the transversely round bunch case (Eq.~\ref{eq:emittance_term_round_beam})
\begin{equation}
\beta^{*} \geq \frac{2\gamma\epsilon_{n}}{\left(1+X\right)\sqrt{\left(\frac{\Delta E_{\gamma}}{E_{\gamma}}\right)^{2}-\left[\left(\frac{\sigma_{\theta}}{E_{\theta}}\right)^{2}+\left(\frac{\sigma_{e}}{E_{e}}\right)^{2}+\left(\frac{\sigma_{L}}{E_{L}}\right)^{2}\right]}}.
\label{eq:beta_star_maximum limitation}
\end{equation}

Bounding the  bandwidth by a lower (Eq.~\ref{eq:bandwidth_limitation_minimum}) and upper (Eq.~\ref{eq:bandwidth_limitation_maximum_approximation}) limit results in myriad combinations of $\beta^{*}$ and $\theta_{\mathrm{col}}$ that satisfy a particular chosen bandwidth.The different $\beta^{*}$, $\theta_{\mathrm{col}}$ combinations each give a different collimated flux; obviously we wish to chose the solution with the largest flux. The collimated flux $\mathcal{F}_{\mathrm{col}}$ of each solution is calculated based on the collimated flux calculation (Eq.~\ref{eq:collimated_flux}) derived in Section~\ref{sec:analytical_collimated_flux}. The solution giving the maximal collimated flux is selected. 

It is not practicable to calculate the flux from every combination of $\beta^{*}$ and $\theta_{\mathrm{col}}$ within the upper (Eq.~\ref{eq:beta_star_maximum limitation}) and lower (Eq.~\ref{eq:bandwidth_limitation_minimum}) bounds. Instead, an array of collimation angles $\theta_{\mathrm{col}}$ from 0 to $1/\gamma$ is used ($\Psi<1$). The maximal collimated flux for the RB case is achieved when $\beta^{*}$ is smallest, as this maximises luminosity, therefore for a given user selected \textit{rms} bandwidth value the corresponding $\beta^{*}$ is calculated using
\begin{equation}
\beta^{*} = \frac{2\gamma\epsilon_{n}}{\left(1+X\right)\sqrt{\left(\frac{\Delta E_{\gamma}}{E_{\gamma}}\right)^{2}-\left[\left(\frac{\sigma_{\theta}}{E_{\theta}}\right)^{2}+\left(\frac{\sigma_{e}}{E_{e}}\right)^{2}+\left(\frac{\sigma_{L}}{E_{L}}\right)^{2}\right]}},
\label{eq:beta_star_round_beam}
\end{equation}
which is a modification of (Eq.~\ref{eq:beta_star_maximum limitation}). A near identical solution can also be found, using simple scaling, for the case of an \texit{FWHM} bandwidth. 

The collimated flux $\mathcal{F}_{\mathrm{col}}$ (Eq.~\ref{eq:collimated_flux}) is calculated for each combination produced via this method. The maximal collimated flux is selected and the combination of $\beta^{*}$ and $\theta_{\mathrm{col}}$ corresponding to this solution is returned. The method described here is a rather brute force methodology to optimising the collimated flux within bandiwdth limits. This process can be applied to the case of a target bandwidth to determine $\theta_{\mathrm{col}}$, $\beta^{*}$, and collimated flux in the selected bandwidth. In addition, applying this method to a series of bandwidths allows us to map the possible operational settings of our ICS source, and to derive tuning curves such as the variation of the collimated flux with bandwidth.

\textcolor{blue}{\textbf{**SHOW A PLOT OF EACH CASE TUNING CURVE (Fcol-rmsBW) IN RB APPROXIMATION**}}

\section{2D Non-Round Beam Optimisation}

In a non-round beam (NRB) optimisation we relax the conditions that are imposed in the round beam case in Section~\ref{sec:RB_optimisation}, so that the transverse normalised emittances in each plane ($\epsilon_{nx}/\epsilon_{ny}$) and the $\beta$-functions at the IP in each direction ($\beta_{x}^{*}/\beta_{y}^{*}$) can differ, as well as the collimation angle. There are now three variables, unlike the two in the 1D RB case in Section~\ref{sec:RB_optimisation}. For a 2D non-round beam optimisation, the selected $\beta$-function variables can not be easily bound or calculated as a function of each other as in (Eq.~\ref{eq:beta_star_round_beam}) of the round beam methodology because of the form of the non-approximated emittance term (Eq.~\ref{eq:emittance_term}), which can not be re-arranged simply like the emittance term in the RB case (Eq.~\ref{eq:emittance_term_round_beam}). Therefore, the 2D non-round beam optimisation can't operate as a simple brute force optimisation method as in the RB optimisation.

The 2D NRB can be framed as a 3-dimensional, double objective non-linear minimisation problem of the form
\begin{equation}
\begin{aligned}
&\underset{\theta_{\mathrm{col}},~\beta_{x}^{*},~\beta_{y}^{*}}{\text{minimize}},  &-\mathcal{F}_{\mathrm{col}}\left(\theta_{\mathrm{col},~\beta_{x}^{*}},~\beta_{y}^{*}\right), \\
& &\left(\frac{\Delta E_{\gamma}}{E_{\gamma}}\right)_{\mathrm{rms}}\left(\theta_{\mathrm{col}},~\beta_{x}^{*},~\beta_{y}^{*}\right), \\
&\text{subject to} &0 < \theta_{\mathrm{col}} <  \theta_{\mathrm{col},\mathrm{max}}, \\
& &0 < \beta_{x}^{*} \leq \beta_{x,\mathrm{max}}^{*}, \\
& &0 < \beta_{y}^{*} \leq \beta_{y,\mathrm{max}}^{*}, 
\end{aligned}
\label{eq:2D_optimisation_definition}
\end{equation}
\textcolor{blue}{**SORT OUT SPACING, number also in wrong place**}
where $\mathcal{F}_{\mathrm{col}}$ is the collimated flux (Eq.~\ref{eq:collimated_flux}) -- the neagative collimated flux is minimised therefore collimated flux is maximised -- and $\left(\Delta E_{\gamma}/E_{\gamma}\right)_{\mathrm{rms}}$ is the \textit{rms} bandwidth (Eq.~\ref{eq:RMS_bandwidth}) are the objective functions, $\theta_{\mathrm{col},\mathrm{max}}$ is the approximate upper bound on the collimation angle (Eq.~\ref{eq:collimation_angle_upper_bound}) and $\beta_{x/y,\mathrm{max}}^{*}$ are the upper bounds of the $\beta$-functions at the IP in each plane, which are set arbitrarily on a case by case basis. Therefore, in order to solve the 2D NRB case, a more sophisticated approach is required where the collimated flux and \textit{rms} bandwidth are traded-off for the tuning curve case or in the single point optimisation case where the collimated flux is maximised and a simple penalty function (Eq.~\ref{eq:penalty_function}) is minimised. Two optimisation methodologies are employed to solve this: a genetic algorithm approach, developed in collaboration with Prof B. Terzic, and a simplex (Nelder-Mead) approach, which are detailed in the following section and are compared in Section~\ref{sec:evaluation_of_optimisation_methods}.

\subsection{Genetic Algorithm Approach}

The genetic algorithm (GA) optimisation uses the minimisation routine of \textsc{SPEA2} \cite{zitzler2001spea2} within the \textsc{PISA} platform \cite{bleuler2003pisa} framework, following the methodology outlined by A. Hofler et al \cite{hofler2013innovative}. The objective functions minimised are the \texit{rms} Bandwidth (Eq.~\ref{eq:RMS_bandwidth}) and $-\mathcal{F}_{\mathrm{col}}$ (Eq.~\ref{eq:collimated_flux}), the negative collimated flux (hence it is maximised) for the tuning curve case. The Pareto front of the tuning curve is defined by the non-dominated points across all of the generation simulated. Whereas the single point optimisation is conducted using the penalty function (Eq.~\ref{eq:penalty_function}) and the negative collimated flux (Eq.~\ref{eq:collimated}) as objective functions. In the case of the single point bandwidth optimisations the non-dominated minimimum penalty function point is selected as the optimum solution, where the associated variables of this point are the optimal configuration of the ICS source.

The genetic algorithm method is a global optimisation technique which provides a set of solutions for each optimisation run, allowing the full solution space to be mapped more effectively. Global optimisation via a genetic algorithm should deliver a global minimum for the bandwidth whilst providing a global maximum for the collimated flux. This method should avoid the pitfalls of local optimisation techniques where a local minima may be returned. \textcolor{blue}{**MORE ABOUT HOW THE OPTIMISATION METHOD ACTUALLY WORKS**}

\textcolor{blue}{**HOW IS THIS CODED?**}

The genetic algorithm approach has been applied to each of the electron bunch parameter cases in Table~\ref{tab:char_opt_electron_bunch_parameters} using the laser parameters in Table~\ref{tab:char_opt_laser_pulse_parameters}. Plots of the tuning curves produced via the genetic algorithm method are shown in Figs.~\ref{fig:case_A_GA_tuning_curves}, \ref{fig:case_B_GA_tuning_curves} and \ref{fig:case_C_GA_tuning_curves}, demonstrating the typical output of the genetic algorithm where the non-dominated Pareto front points are highlighted and the other trial points are shown. Onward from this section in the thesis only the Pareto front points and their corresponding variables will be included in plots to aid comparison of optimisation methods.

\begin{figure}[!h]
\centering
\includegraphics[width=\textwidth]{Figures/Optimisation_and_Characterisation_of_Inverse_Compton_Scattering_Sources/CaseA_GA_Tuning_Curve.pdf}
\caption{Case A genetic algorithm tuning curves (solution and parameter space) produced using 200 generations and 50 individuals showing the non-dominated Pareto front points (red) and the dominated trial points (blue). Top Left: collimated flux as a function of \textit{rms} bandwidth solution space. Top Right: parameter space plot of the $\beta$-function in the $x$ plane as a function of the $\beta$-function in the $y$ plane at the IP. Bottom Left: parameter space plot of the $\beta_{x}$-function at the IP as a function of the collimation angle. Bottom Right: parameter space plot of the $\beta_{y}$-function at the IP as a function of the collimation angle.}
\label{fig:case_A_GA_tuning_curves}
\end{figure}

\textcolor{blue}{**TALK ABOUT CASE A OPTIMISATION**}

\begin{figure}[!h]
\centering
\includegraphics[width=\textwidth]{Figures/Optimisation_and_Characterisation_of_Inverse_Compton_Scattering_Sources/CaseB_GA_Tuning_Curve.pdf}
\caption{Case B genetic algorithm tuning curves (solution and parameter space) produced using 200 generations and 50 individuals showing the non-dominated Pareto front points (red) and the dominated trial points (blue). Top Left: collimated flux as a function of \textit{rms} bandwidth solution space. Top Right: parameter space plot of the $\beta$-function in the $x$ plane as a function of the $\beta$-function in the $y$ plane at the IP. Bottom Left: parameter space plot of the $\beta_{x}$-function at the IP as a function of the collimation angle. Bottom Right: parameter space plot of the $\beta_{y}$-function at the IP as a function of the collimation angle.}
\label{fig:case_B_GA_tuning_curves}
\end{figure}

\textcolor{blue}{**TALK ABOUT CASE B OPTIMISATION**}

\begin{figure}[!h]
\centering
\includegraphics[width=\textwidth]{Figures/Optimisation_and_Characterisation_of_Inverse_Compton_Scattering_Sources/CaseC_GA_Tuning_Curve.pdf}
\caption{Case C genetic algorithm tuning curves (solution and parameter space) produced using 200 generations and 50 individuals showing the non-dominated Pareto front points (red) and the dominated trial points (blue). Top Left: collimated flux as a function of \textit{rms} bandwidth solution space. Top Right: parameter space plot of the $\beta$-function in the $x$ plane as a function of the $\beta$-function in the $y$ plane at the IP. Bottom Left: parameter space plot of the $\beta_{x}$-function at the IP as a function of the collimation angle. Bottom Right: parameter space plot of the $\beta_{y}$-function at the IP as a function of the collimation angle.}
\label{fig:case_C_GA_tuning_curves}
\end{figure}

\textcolor{blue}{**TALK ABOUT CASE C OPTIMISATION**}

\subsection{Nelder--Mead Approach}

\textcolor{blue}{\textbf{**RIPPED FROM THE COMPTON OPTIMISATION PAPER**}}

Within the Nelder-Mead optimisation, the collimated flux (Eq.~\ref{eq:collimated_flux}) objective function is maximised and the bandwidth penalty function (Eq.~\ref{eq:penalty_function}) is minimised. In order to produce tuning curves using the Nelder-Mead method, the optimisation is applied to an array of bandwidth values.

This optimisation is based on a local minimisation routine therefore, unlike in the GA method, only a single solution space point is returned for each optimisation. This means the full solution space is not mapped in this optimisation. The Nelder-Mead optimisation may also fail to find the optimal solution and become trapped in a local minima, however the parameter space is \textcolor{blue}{**ASSUMED, NOT PROVEN**} simple enough to produce a global minima result.

\textcolor{blue}{\textbf{**SHOW PLOTS OF THE 3 CASES TUNING CURVES (Fcol-rmsBW)**}}

\section{Evaluation of Optimisation Methods} 
\label{sec:evaluation_of_optimisation_methods}

\subsection{Single Point Bandwidth Optimisations}

\begin{table}[!h]
\centering
\caption{Single point optimisations for the transverse profile matching (TPM), round beam (RB), non-round beam Simplex (NRB Simplex) and non-round beam genetic algorithm (NRB GA) methods of all cases. \textit{Rms} bandwidths of 0.5\% (Case A), 2\% (Case B), 0.5\% (Case C) are chosen to evaluate the single point optimisation methodologies for each individual case.}
\vspace{3mm}
\resizebox{\columnwidth}{!}{
\begin{threeparttable}
\begin{tabular}{lccccc}
\hline\hline
Method & \textit{rms} Bandwidth (\%)  & Collimated Flux (ph/\si{\second}) & $\beta_{x}^{*}$-function (\si{\meter}) & $\beta_{y}^{*}$-function (\si{\meter}) & Collimation angle (\si{\milli\radian}) \\
\hline
\multicolumn{6}{c}{\textbf{Case A}} \\
\hline
TPM & 0.5 & 7.37$\times 10^{8}$ & 3.53 & 3.53 & 0.068  \\
RB & 0.5 & 8.62$\times 10^{8}$ & 1.15 & 1.15 & 0.066 \\
NRB Simplex & 0.5 & 8.81$\times 10^{8}$ & 1.69 & 0.88 & 0.066  \\
NRB GA & 0.5 & 8.86$\times 10^{8}$ & 2.11 & 0.867 & 0.066  \\
\hline
\multicolumn{6}{c}{\textbf{Case B}} \\
\hline
TPM~\tnote{*} & -- & -- & -- & -- & --  \\
RB~\tnote{$\dagger$} & -- & -- & -- & -- & -- \\
NRB Simplex & 2.0 & 9.19$\times 10^{9}$ & 3.46 & 0.10 & 0.178 \\
NRB GA & 2.0 & 1.04$\times 10^{10}$ & 11.05 & 0.20 & 0.194 \\
\hline
\multicolumn{6}{c}{\textbf{Case C}} \\
\hline
TPM & 0.5 & 8.35$\times 10^{7}$ & 0.45 & 0.45 & 2.63 \\
RB & 0.5 & 1.16$\times 10^{8}$ & 0.015 & 0.015 & 2.62  \\
NRB Simplex & 0.5 & 1.16$\times 10^{8}$ & 0.016 & 0.015 & 2.63 \\
NRB GA & 0.5 & 1.17$\times 10^{8}$ & 0.029 & 0.013 & 2.64 \\
\hline\hline
\end{tabular}
\begin{tablenotes}[flushedleft]
\item[*]{Transverse profile matching settings aren't possible because the emittance term (Eq.~\ref{eq:emittance_term}) for $\sigma_{\mathrm{electron}} = \sigma_{L}$ leads to a larger than 2\% \textit{rms} bandwidth.}
\item[$\dagger$]{This case doesn't satisfy the round beam condition ($\epsilon_{nx} \neq \epsilon_{ny}$), therefore the RB optimisation can't be utilised.}
\end{tablenotes}
\end{threeparttable}}
\label{tab:single_point_optimisations}
\end{table}


\subsection{Tuning Curve Optimisations}

\textcolor{blue}{**4-PANE TUNING CURVE OPTIMISATION PLOTS COMPARING ALL METHODS FOR EACH CASE**}
 

\end{document}